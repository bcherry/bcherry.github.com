<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Adequately Good - Posts tagged “javascript”</title>

    <!-- CSS, including Blueprint, jQuery w/Smoothness, and AG CSS -->
    <link rel="stylesheet" href="/css/blueprint/blueprint.min.css" media="screen, projection" />
    <link rel="stylesheet" href="/css/blueprint/print.min.css" media="print" />
    <!--[if lt IE 8]>
      <link rel="stylesheet" href="/css/blueprint/ie.min.css" media="screen, projection">
    <![endif]-->
    <link rel="stylesheet" href="/css/ag.min.css" media="screen" />

    <!-- Extra <head> Links -->
    <link rel="alternate" type="application/atom+xml" title="Adequately Good Atom Feed" href="http://www.adequatelygood.com/feeds/atom.xml" />

    <!-- TODO: favicon -->

    <!-- IE HTML5 Compatibility -->
    <!--[if IE]>
      <script type="text/javascript">
        (function () {
          var tags = "header hgroup nav article time footer".split(" "),
            i = 0,
            l = tags.length;
          for (; i < l; i += 1) {
            document.createElement(tags[i]);
          }
        }());
      </script>
    <![endif]-->
  </head>
  <body>
    <a name="top"></a>
    <div id="container" class="container">

      <!-- Header -->
      <header class="span-24 last">
        <!-- Title -->
        <div id="title" class="span-24 last">
          <div class="span-17 colborder prepend-top append-bottom">
            <hgroup>
              <h1>
                <a href="/">adequately good</a>
              </h1>
              <h3 class="prepend-2 alt">decent programming advice</h3>
            </hgroup>
          </div>
          <div class="span-6 last prepend-top append-bottom">
            <h2>
              written by
              <a href="http://twitter.com/bcherry">ben cherry</a>
            </h2>
          </div>
        </div>

        <hr />

        <!-- Navigation Bar -->
        <nav class="prepend-2 span-20 append-2 last append-bottom">
          <div class="span-5">
            <a href="/">home</a>
          </div>
          <div class="span-5">
            <a href="#" id="archiveLink">archives</a>
          </div>
          <div class="span-5">
            <a href="/About-Ben">about</a>
          </div>
          <div class="span-5 last">
            <a href="/feeds/atom.xml">feed</a>
          </div>
        </nav>

        <!-- Archives Links -->
        <div id="archives" class="span-24 last smallalts" style="display:none;">
          <hr />
          <div class="archivelinks">
            <span class="alt">posts by year</span>
            
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
                  <a class="tight" href="/2009">2009</a>
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
              
            
              
                
                
                
                  <a class="tight" href="/2010">2010</a>
                
              
            
              
                
                
                
              
            
              
                
                
                
                  <a class="tight" href="/2011">2011</a>
                
              
            
          </div>
        </div>

        <hr />
      </header>

      <div id="colcontainer" class="span-24 last">
        <!-- Main content: Posts, etc. -->
        <div id="content" class="span-17 colborder">
          <a name="main"></a>
          <div class="smallalts listing">
  <span class="alt">all posts filed under</span>
  <a class="tight" href="/tags/javascript">javascript</a>
</div>

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2011-04-07" pubdate>2011-04-07</time>
  
  <h1><a href="/2011/4/Replacing-setTimeout-Globally">Replacing `setTimeout` Globally</a></h1>
</header>
  <div class="span-17 last entry">
    <p>Sometimes, you might want to overwrite built-in global methods like <code>setTimeout</code> and <code>setInterval</code>. If you try, you might find that it&#8217;s much harder than you think to accomplish this in every browser, particularly if you ever want to find the originals again. After a lot of painful experimentation, I think I have a definitive solution that works in all browsers with minimal side-effects.</p>

<h2 id='failed_approaches'>Failed Approaches</h2>

<p>I started out with the simple approach:</p>

<pre><code>setTimeout = function() {};
// or
window.setTimeout = function() {};</code></pre>

<p>This seems to work in most browsers. However, Internet Explorer 8 and below are not appreciative of this technique. In the first case, IE will actually throw an exception saying <code>&quot;Object doesn&#39;t support this action&quot;</code>. The second option works, but it will only affect the value of <code>window.setTimeout</code>, leaving plain old global <code>setTimeout</code> alone. This is workable, but not ideal. Time to look for another solution.</p>

<h3 id='another_attempt'>Another Attempt</h3>

<p>After speaking with @jcummins about this, we thought about using the <code>var</code> keyword, and seeing if that would help. So that brings me to my next approach:</p>

<pre><code>var setTimeout = function() {};</code></pre>

<p>The good news is that this works across the board! Both <code>setTimeout</code> and <code>window.setTimeout</code> now reference my new function, in all browsers, and you can safely do any assignments needed, no exceptions thrown. But now the question is, where did the original <code>setTimeout</code> go? It&#8217;s not an easy thing to find.</p>

<p>You might try something like the following:</p>

<pre><code>var temp = setTimeout,
    setTimeout = function() {};</code></pre>

<p>Now, you might expect <code>temp</code> to contain the original <code>setTimeout</code>, but it unfortunately will come up <code>undefined</code>. This is due to <a href='http://www.adequatelygood.com/2010/2/JavaScript-Scoping-and-Hoisting'>JavaScript hoisting</a>. I even tried <code>var temp = window.setTimeout</code> first, but the property on <code>window</code> was immediately hoisted on top.</p>

<p>So, I resolved to find another way to get at the original value. After some digging, I discovered a reference to the original <code>setTimeout</code> on the window&#8217;s prototype, which you can access at <code>window.constructor.prototype.setTimeout</code>. Alright! Things are looking good. Unfortunately, things quickly went downhill.</p>

<p>1. In most browsers, <code>window</code> is constructed by a function named <code>&quot;DOMWindow&quot;</code>. That is, <code>window.constructor.name === &quot;DOMWindow&quot;</code>. However, in Safari this is not the case, the <code>constructor</code> property instead references <code>Object</code>. We don&#8217;t have a way to access <code>DOMWindow</code> directly, so we can&#8217;t get to the prototype. Luckily, we can use the ECMAScript 5 <code>__proto__</code> property, and find <code>setTimeout</code> at <code>window.__proto__.setTimeout</code>. So my catch-all became <code>(window.__proto__ || window.constructor.prototype).setTimeout</code>. 2. It turns out Opera has the same problem as Safari, and we can&#8217;t access the correct prototype at <code>window.constructor.prototype</code>. However, it also doesn&#8217;t seem able to access it at <code>window.__proto__</code>, leaving us low on options. More on that in a bit. 3. IE7 and below don&#8217;t have a <code>constructor</code> <em>or</em> a <code>__proto__</code> property on <code>window</code>, and there doesn&#8217;t seem to be any other way to get direct access to the window&#8217;s prototype.</p>

<p>At this point, I declared searching for the original copies of <code>setTimeout</code> outside of the global scope a lost cause, and went back to the drawing board. You could, in theory, instantiate a new <code>&lt;iframe&gt;</code> and copy <code>setTimeout</code> from it, but I didn&#8217;t want to introduce that much overhead.</p>

<h2 id='a_solution'>A Solution</h2>

<p>At this point, I figured the best solution would be to circumvent JavaScript&#8217;s hoisting rules. As we know, hoisting occurs immediately after entering an execution context. So, to dodge it, we&#8217;d have to introduce a second execution context. You could do this easily in HTML:</p>

<pre><code>&lt;script&gt;
  var temp = setTimeout;
&lt;/script&gt;
&lt;script&gt;
  var setTimeout = function() {};
&lt;/script&gt;</code></pre>

<p>However, I was looking for a pure JS solution. So, after some soul-searching, I decided I&#8217;d pull out <code>eval</code>.</p>

<pre><code>var temp = setTimeout;
eval(&quot;var setTimeout;&quot;);
setTimeout = function() {};</code></pre>

<p>Done and done. The most flexible thing to do is just to quickly fix the inconsistency where IE doesn&#8217;t allow you to overwrite <code>setTimeout</code> directly, and then proceed to do as you need. Here&#8217;s some quick sample code, though you could easily adapt this better into your own project:</p>

<pre><code>var __originals = {
  st: setTimeout,
  si: setInterval,
  ct: clearTimeout,
  ci: clearInterval
};

eval(&quot;var setTimeout, setInterval, clearTimeout, clearInterval;&quot;);

setTimeout = __originals.st;
setInterval = __originals.si;
clearTimeout = __originals.ct;
clearInterval = __originals.ci;

__originals = undefined;</code></pre>

<p>This snippet will smooth out that inconsistency in Internet Explorer, and allow you to proceed with whatever overrides or replacements you need on those methods. No need to use <code>var</code> again in the future, so you can avoid the hoisting pains. I&#8217;ve tested this in IE6, 7, 8, and 9, as well as Chrome, Safari, Firefox 3/4, and Opera, all on Mac and Windows, and it&#8217;s rock-solid.</p>

<h2 id='update_a_better_solution'>Update! A Better Solution</h2>

<p>After further investigation, helped by many including @angusTweets and @kangax, I have fully uncovered the problem in IE, with an extremely simple and safe solution.</p>

<p>It turns out that the problem is not always present. For instance, open up a brand new, blank window in IE7 or IE8, and try the following in the JS console:</p>

<pre><code>window.setTimeout = 1;
setTimeout; // 1
setTimeout = 2; // 2</code></pre>

<p>But then, try this instead (again, in a fresh window):</p>

<pre><code>setTimeout;
window.setTimeout = 1;
setTimeout; // {...}
window.setTimeout; // 1
setTimeout = 1; // Error</code></pre>

<p>So what&#8217;s going on here? Well, I&#8217;ve come up with a solid theory.</p>

<p>Initially, the property <code>setTimeout</code> exists on the <code>prototype</code> of <code>window</code>, not on <code>window</code> itself. So, when you ask for <code>window.setTimeout</code>, it actually traverses one step on the prototype chain to resolve the reference. Similarly, when you ask for <code>setTimeout</code>, it traverses down the scope chain, then to <code>window</code>, then down the prototype chain to resolve the reference.</p>

<p>I suspect that IE has a built-in optimization where it automatically caches the resolution of implied globals that are discovered all the way down on the prototype of the global object. It would have good reason to do so, as these are commonly requested references, and traversing that chain is costly. However, it must be setting this reference as read-only, since it&#8217;s just a caching optimization. This has the unfortunate side-effect of causing an exception to be thrown when attempting to assign to the reference by using it as an lvalue. The only way to kill this new reference is by using <code>var</code> in the global scope, but this puts us in the hoisting problem. What to do?</p>

<p>Assuming this theory is correct, there&#8217;s actually a simple solution. To prevent this &#8220;optimization&#8221;, we simply need to move the reference one step up the chain, directly onto <code>window</code>. Luckily, this is quite easy:</p>

<pre><code>window.setTimeout = window.setTimeout;</code></pre>

<p>That&#8217;s it! Assuming you&#8217;ve done this <strong>before</strong> any reference to <code>setTimeout</code> on its own, this will move the reference and completely avoid this problem. You may now safely assign to <code>setTimeout</code> without using <code>var</code>. This works because <code>window.setTimeout</code>, when used as an lvalue (on the left side of the assignment), does not walk the prototype chain, but on the right side, it does. So this will always pull a property out of the prototype chain and put it right on the object. Incidentally, IE exhibits the same problem with every other property on the window prototype, and the same solution will fix them. You can easily find the other properties, but a few of them are <code>alert</code>, <code>attachEvent</code>, <code>scrollTo</code>, <code>blur</code>, and many others.</p>

<p>This solution has been tested in all browsers, has no side effects, and is wonderfully simple. It&#8217;s always nice when things work out that way.</p>
  </div>
</article>

  

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-07-25" pubdate>2010-07-25</time>
  
  <h1><a href="/2010/7/Saner-HTML5-History-Management">Saner HTML5 History Management</a></h1>
</header>
  <div class="span-17 last entry">
    <h2 id='hashchange'>Hashchange</h2>

<p>This event is quite simple. Whenever the <code>window.location.hash</code> property changes, by following a link, setting the property, editing the URL bar, or using back/forward to move through browser history, the &#8220;hashchange&#8221; event is fired from the window. Using it is really easy:</p>

<pre><code>window.onhashchange = function() {
	alert(&quot;hash changed!&quot;);
};
window.location.hash = Math.random(); // alerts &quot;hash changed!&quot;</code></pre>

<p>This feature is implemented in recent versions of all major browsers. In older browsers like Internet Explorer 6 and 7, you can easily provide it by polling the hash property on an interval, and manually firing an event when it changes. This is easy to build into a jQuery plugin, which <a href='http://benalman.com/'>Ben Alman</a> did in the robust <a href='http://benalman.com/projects/jquery-hashchange-plugin/'>jquery.hashchange.js plugin</a>.</p>

<h2 id='history_management'>History Management</h2>

<p>This feature is a bit more complex. Browsers that support it add a <code>window.history</code> object, with the following properties:</p>

<ul>
<li><code>window.history.back()</code> and <code>window.history.forward()</code>, which provide programmatic interfaces to browser back and forward functions.</li>

<li><code>window.history.pushState(stateObj, title, url)</code>. This method pushes a new entry into the browser history, which then becomes the browser&#8217;s current state. You can provide any JSON-stringifiable object to send with it, and the browser will provide that object again when you navigate to that point (more on that in a bit). More importantly, if you provide a URL, the browser will change the URL displayed in the address bar, without reloading the page. The new URL must be on the same domain, but you can change the rest of it, which is the <code>window.location.pathname</code> and <code>window.location.hash</code>. Changing the URL in this way will not trigger a &#8220;hashchange&#8221; event, though.</li>

<li><code>window.history.replaceState(stateObj, title, url)</code>. This is just like <code>window.history.pushState</code>, except that the current browser state is removed from the history, so you cannot hit &#8220;back&#8221; to return to it.</li>

<li><code>window.onpopstate</code>. This event is fired whenever a state object is removed from the browser history, which occurs on browser &#8220;back&#8221; or &#8220;forward&#8221;. State objects are persisted on the user&#8217;s hard disk between sessions, which is a nice feature. The object passed into a call to <code>pushState</code> or <code>replaceState</code> is provided as the <code>state</code> property on the event object in the &#8220;popstate&#8221; event.</li>
</ul>

<p>This feature is implemented in the latest versions of WebKit, which includes Safari and Chrome. Additionally, the Firefox 4 betas include support for this.</p>

<h2 id='whats_the_use_case'>What&#8217;s the Use Case?</h2>

<p>The new history management stuff is very promising, because it allows a web application to live across many physical URLs, but be run in a single instance. This is important for certain kinds of applications, where using hashes is not universally suitable.</p>

<p>For instance, at Twitter, we currently update your URL hash as you navigate around the application, to make bookmarkable pages like <a href='http://twitter.com/#replies'>http://twitter.com/#replies</a>. However, we force a full page load for certain pages, most notably profile pages (e.g. <a href='http://twitter.com/bcherry'>http://twitter.com/bcherry</a>) and permalink pages (e.g. <a href='http://twitter.com/bcherry/status/18966802499'>http://twitter.com/bcherry/status/18966802499</a>). This is so that those URLs can be copied from the address bar and posted on the web.</p>

<p>We want to make sure that users without JavaScript and search engine bots crawling links to our site will get the correct page from the server (since the browser does not send a hash along to the server). This would not be possible if those URLs used hashes. Unfortunately, this means the application is slower, because a full page load is needed going into and out of those locations.</p>

<p>This is where HTML5 History Management could be useful.</p>

<h2 id='so_whats_the_problem'>So What&#8217;s the Problem?</h2>

<p>Unfortunately, the existing implementation of history management is not useful, and not in the spirit of the web.</p>

<p>Our web applications should be built to respond to a URL. Both the client and server versions of an application should understand a shared URL structure, and know how to present the same page to the browser that reflects that URL.</p>

<p>Allowing developers to store extra state information in the browser history is missing the point. The only thing stored in history should be a URL, and the browser can associate a title with it if it chooses.</p>

<p>This is RESTful design, mirrored on client and server. Modern browsers can support changing the URL without reloading the page from the server, and older ones can continue to hit the server every time.</p>

<p>In this way, we can build applications that degrade correctly in older browsers, and when viewed by bots, while providing a faster experience for users with modern browsers.</p>

<h2 id='enter_pathchange'>Enter &#8220;pathchange&#8221;</h2>

<p>Both &#8220;hashchange&#8221; and <code>pushState</code>/&#8221;popstate&#8221; should be replaced with &#8220;pathchange&#8221;, which is an event that fires when the URL changes in any way. This event does not provide any information, the application should inspect the current URL to discover the state it should enter. Relative links within a page should not force page reloads, they should instead just trigger the &#8220;pathchange&#8221; event.</p>

<p>It turns out that it&#8217;s possible to implement this event in modern browsers now, based on the features they already have. Here&#8217;s how:</p>

<ol>
<li>Listen to &#8220;hashchange&#8221;, and trigger &#8220;pathchange&#8221; when it occurs</li>

<li>Poll the hash in browsers without &#8220;hashchange&#8221; support, and trigger &#8220;hashchange&#8221;, which triggers &#8220;pathchange&#8221;</li>

<li>With history support, listen to &#8220;popstate&#8221;, and trigger &#8220;pathchange&#8221; when it occurs</li>

<li>With history support, intercept all relative links when they are clicked, and prevent normal navigation. Call <code>window.history.pushState(null, null, href)</code> instead, and trigger a &#8220;pathchange&#8221;.</li>

<li>Provide a helper function to make navigation to new URLs using <code>window.history.pushState</code>, when supported, easy.</li>
</ol>

<p>I&#8217;ve implemented all of this as a <a href='http://www.bcherry.net/static/lib/js/jquery.pathchange.js'>jQuery plugin</a> that is quite easy to use:</p>

<pre><code>$(function() {
	$.pathchange.init(); // setup event listeners, etc.
	$(window).pathchange(function() {
		respondToUrl();
	}).trigger(&quot;pathchange&quot;);

	$.pathchange.changeTo(&quot;/foo&quot;);
});</code></pre>

<p>I&#8217;ve also created a demo page that presents <a href='http://www.bcherry.net/playground/sanerhtml5history'>A Saner HTML5 History App</a> that uses <a href='http://www.bcherry.net/static/lib/js/jquery.pathchange.js'>jquery.pathchange.js</a> under the hood. Check it out in various browsers to see the HTML5 magic at work, and be sure to use your browser &#8220;back&#8221; and &#8220;forward&#8221; buttons, and reload the page a few times.</p>

<p>That&#8217;s my take on the HTML5 history features. It&#8217;s unfortunate that what the browsers are implementing is not what we really need, but it&#8217;s encouraging that they do provide enough to implement what we do really need. Let me know in the comments if you agree, disagree, or have questions about my approach.</p>
<span class='note'>___Note Number One: It's also worth pointing out that I discovered a [serious bug](https://bugs.webkit.org/show_bug.cgi?id=42940) in WebKit's implementation of history management while working on this today.  In short, the "popstate" event is often lost when the network is occupied, which makes little sense.  [Here's a demo page with a reproducible case](http://www.bcherry.net/playground/pushstate) that I threw together.  It fires off a request to download an image which takes 1s on every "popstate", which means hitting "back" more than once every second leads to lost history entries and an application that gets out of sync with the URL.  You could work around this by polling the URL in addition to listening to "popstate", but it's not a good workaround.  Until this is fixed, you'll have to be wary of this if you ship this feature to your users, and it probably is not suitable for very complex AJAX apps.  Firefox 4 does not have the same problem.___</span><span class='note'>___Note Number 2: This article was originally published around 4am PST on July 26th.  The author published a revision around 8pm PST the following day, to make it a little less incohorent and a little more useful.  Luckily, the author uses Git to prepare Markdown-formatted articles, so you can [view the diff](http://github.com/bcherry/adequatelygood/commit/eb688c7809e8d5f61f9ed12442d3a578d46fab97) if you'd like to find out what changed.___</span>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-07-08" pubdate>2010-07-08</time>
  
  <h1><a href="/2010/7/Writing-Testable-JavaScript">Writing Testable JavaScript</a></h1>
</header>
  <div class="span-17 last entry">
    <p>The engineering culture at Twitter requires tests. Lots of tests. I haven&#8217;t had formal experience with JavaScript testing before Twitter, so I&#8217;ve been learning a lot as I go. In particular, a number of patterns I used to use, write about, and encourage have turned out to be bad for writing testable code. So I thought it would be worthwhile to share a few of the most important principles I&#8217;ve developed for writing testable JavaScript. The examples I provide are based on <a href='http://docs.jquery.com/QUnit'>QUnit</a>, but should be just as applicable to any JavaScript testing framework.</p>

<h2 id='avoid_singletons'>Avoid Singletons</h2>

<p>One of my most popular posts was about using <a href='http://www.adequatelygood.com/2010/3/JavaScript-Module-Pattern-In-Depth'>JavaScript Module Pattern</a> to create powerful <strong>singletons</strong> in your application. This approach can be simple and useful, but it creates problems for testing, for one simple reason: <strong><em>singletons suffer state pollution between tests</em></strong>. Rather than creating your singletons as modules, you should compose them as constructable objects, and assign a single, default instance at the global level in your application init.</p>

<p>For example, consider the following singleton module (contrived example, of course):</p>

<pre><code>var dataStore = (function() {
	var data = [];
	return {
		push: function (item) {
			data.push(item);
		},
		pop: function() {
			return data.pop();
		},
		length: function() {
			return data.length;
		}
	};
}());</code></pre>

<p>With this module, we may wish to test the <code>foo.bar</code> method. Here&#8217;s a simple QUnit test suite:</p>

<pre><code>module(&quot;dataStore&quot;);
test(&quot;pop&quot;, function() {
	dataStore.push(&quot;foo&quot;);
	dataStore.push(&quot;bar&quot;)
	equal(dataStore.pop(), &quot;bar&quot;, &quot;popping returns the most-recently pushed item&quot;);
});

test(&quot;length&quot;, function() {
	dataStore.push(&quot;foo&quot;);
	equal(dataStore.length(), 1, &quot;adding 1 item makes the length 1&quot;);
});</code></pre>

<p>When running this test suite, the assertion in the <code>length</code> test will fail, but it&#8217;s not clear from looking at it why it should. The problem is that state has been left in <code>dataStore</code> from the previous test. Merely re-ordering these tests will cause the <code>length</code> test to pass, which is a clear red flag that something is wrong. We could fix this with setup or teardown that reverts the state of <code>dataStore</code>, but that means that we need to constantly maintain our test boilerplate as we make implementation changes in the <code>dataStore</code> module. A better approach is the following:</p>

<pre><code>function newDataStore() {
	var data = [];
	return {
		push: function (item) {
			data.push(item);
		},
		pop: function() {
			return data.pop();
		},
		length: function() {
			return data.length;
		}
	};
}

var dataStore = newDataStore();</code></pre>

<p>Now, your test suite will look like this:</p>

<pre><code>module(&quot;dataStore&quot;);
test(&quot;pop&quot;, function() {
	var dataStore = newDataStore();
	dataStore.push(&quot;foo&quot;);
	dataStore.push(&quot;bar&quot;)
	equal(dataStore.pop(), &quot;bar&quot;, &quot;popping returns the most-recently pushed item&quot;);
});

test(&quot;length&quot;, function() {
	var dataStore = newDataStore();
	dataStore.push(&quot;foo&quot;);
	equal(dataStore.length(), 1, &quot;adding 1 item makes the length 1&quot;);
});</code></pre>

<p>This allows our global <code>dataStore</code> to behave exactly as it did before, while allowing our tests to avoid polluting each other. Each test owns its own instance of a <code>DataStore</code> object, which will be garbage collected when the test completes.</p>

<h2 id='avoid_closurebased_privacy'>Avoid Closure-based Privacy</h2>

<p>Another pattern I used to promote is <a href='http://www.crockford.com/javascript/private.html'>real private members in JavaScript</a>. The advantage is that you can keep globally-accessible namespaces free of unnecessary references to private implementation details. However, overuse of this pattern can lead to untestable code. This is because <strong><em>your test suite cannot access, and thus cannot test, private functions hidden in closures</em></strong>. Consider the following:</p>

<pre><code>function Templater() {
	function supplant(str, params) {
		for (var prop in params) {
			str.split(&quot;{&quot; + prop +&quot;}&quot;).join(params[prop]);
		}
		return str;
	}

	var templates = {};

	this.defineTemplate = function(name, template) {
		templates[name] = template;
	};

	this.render = function(name, params) {
		if (typeof templates[name] !== &quot;string&quot;) {
			throw &quot;Template &quot; + name + &quot; not found!&quot;;
		}

		return supplant(templates[name], params);
	};
}</code></pre>

<p>The crucial method for our <code>Templater</code> object is <code>supplant</code>, but we cannot access it from outside the closure of the constructor. Thus, a testing suite like QUnit cannot hope to verify that it works as intended. In addition, we cannot verify that our <code>defineTemplate</code> method does anything without trying a <code>.render()</code> call on the template and watching for an exception. We could simply add a <code>getTemplate()</code> method, but then we&#8217;d be adding methods to the public interface solely to allow testing, which is not a good approach. While the issues here are probably just fine in this simple example, building complex objects with important private methods will lead to relying on untestable code, which is a red flag. Here&#8217;s a testable version of the above:</p>

<pre><code>function Templater() {
	this._templates = {};
}

Templater.prototype = {
	_supplant: function(str, params) {
		for (var prop in params) {
			str.split(&quot;{&quot; + prop +&quot;}&quot;).join(params[prop]);
		}
		return str;
	},
	render: function(name, params) {
		if (typeof this._templates[name] !== &quot;string&quot;) {
			throw &quot;Template &quot; + name + &quot; not found!&quot;;
		}

		return this._supplant(this._templates[name], params);
	},
	defineTemplate: function(name, template) {
		this._templates[name] = template;
	}
};</code></pre>

<p>And here&#8217;s a QUnit test suite for it:</p>

<pre><code>module(&quot;Templater&quot;);
test(&quot;_supplant&quot;, function() {
	var templater = new Templater();
	equal(templater._supplant(&quot;{foo}&quot;, {foo: &quot;bar&quot;}), &quot;bar&quot;))
	equal(templater._supplant(&quot;foo {bar}&quot;, {bar: &quot;baz&quot;}), &quot;foo baz&quot;));
});

test(&quot;defineTemplate&quot;, function() {
	var templater = new Templater();
	templater.defineTemplate(&quot;foo&quot;, &quot;{foo}&quot;);
	equal(template._templates.foo, &quot;{foo}&quot;);
});

test(&quot;render&quot;, function() {
	var templater = new Templater();
	templater.defineTemplate(&quot;hello&quot;, &quot;hello {world}!&quot;);
	equal(templater.render(&quot;hello&quot;, {world: &quot;internet&quot;}), &quot;hello internet!&quot;);
});</code></pre>

<p>Notice that our test for <code>render</code> is really just a test that <code>defineTemplate</code> and <code>supplant</code> integrate correctly with each other. We&#8217;ve already tested those methods in isolation, which will allow us to easily discover which components are really breaking when tests of the <code>render</code> method fail.</p>

<h2 id='write_tight_functions'>Write Tight Functions</h2>

<p>Tight functions are important in any language, but JavaScript presents its own reasons to do so. Much of what you do with JavaScript is done against global singletons provided by the environment, and which your test suite relies on. For instance, testing a URL re-writer will be difficult if all of your methods try to assign <code>window.location</code>. Instead, you should <strong><em>break your system into its logical components that decide what to do, then write short functions that actually do it</em></strong>. You can test the logical functions with various inputs and outputs, and leave the final function that modifies <code>window.location</code> untested. Provided you&#8217;ve composed your system correctly, this should be safe.</p>

<p>Here&#8217;s an example URL rewriter that is not testable:</p>

<pre><code>function redirectTo(url) {
	if (url.charAt(0) === &quot;#&quot;) {
		window.location.hash = url;
	} else if (url.charAt(0) === &quot;/&quot;) {
		window.location.pathname = url;
	} else {
		window.location.href = url;
	}
}</code></pre>

<p>The logic in this example is relatively simple, but we can imagine a more complex redirecter. As complexity grows, we will not be able to test this method without causing the window to redirect, thus leaving our test suite entirely.</p>

<p>Here&#8217;s a testable version:</p>

<pre><code>function _getRedirectPart(url) {
	if (url.charAt(0) === &quot;#&quot;) {
		return &quot;hash&quot;;
	} else if (url.charAt(0) === &quot;/&quot;) {
		return &quot;pathname&quot;;
	} else {
		return &quot;href&quot;;
	}
}

function redirectTo(url) {
	window.location[_getRedirectPart(url)] = url;
}</code></pre>

<p>And now we can write a simple test suite for <code>_getRedirectPart</code>:</p>

<pre><code>test(&quot;_getRedirectPart&quot;, function() {
	equal(_getRedirectPart(&quot;#foo&quot;), &quot;hash&quot;);
	equal(_getRedirectPart(&quot;/foo&quot;), &quot;pathname&quot;);
	equal(_getRedirectPart(&quot;http://foo.com&quot;), &quot;href&quot;);
});</code></pre>

<p>Now the meat of <code>redirectTo</code> has been tested, and we don&#8217;t have to worry about accidentally redirecting out of our test suite.</p>
<span class='note'>__Note__: There is an alternative solution, which is to create a `performRedirect` function that does the location change, but stub that out in your test suite.	 This is a common practice for many, but I've been trying to avoid method stubbing.	 I find basic QUnit to work well in all situations I've found so far, and would prefer to not have to remember to stub out a method like that for my tests, but your case may differ.</span>
<h2 id='write_lots_of_tests'>Write Lots of Tests</h2>

<p>This is a no-brainer, but it&#8217;s important to remember. Many programmers write too few tests because writing tests is hard, or lots of work. I suffer from this problem all the time, so I threw together a little helper for QUnit that makes writing lots of tests a lot easier. It&#8217;s a function called <code>testCases</code> which you call within a <code>test</code> block, passing a function, calling context, and array of inputs/outputs to try and compare. You can quickly build up a robust suite for your input/output functions for rigorous testing.</p>

<pre><code>function testCases(fn, context, tests) {
	for (var i = 0; i &lt; tests.length; i++) {
		same(fn.apply(context, tests[i][0]), tests[i][1],
			tests[i][2] || JSON.stringify(tests[i]));
	}
}</code></pre>

<p>And here&#8217;s a simple example use:</p>

<pre><code>test(&quot;foo&quot;, function() {
	testCases(foo, null, [
		[[&quot;bar&quot;, &quot;baz&quot;], &quot;barbaz&quot;],
		[[&quot;bar&quot;, &quot;bar&quot;], &quot;barbar&quot;, &quot;a passing test&quot;]
	]);
});</code></pre>

<h2 id='conclusions'>Conclusions</h2>

<p>There is plenty more to write about testable JavaScript, and I&#8217;m sure there are many good books, but I hope this was a good overview of practical cases I encounter on a daily basis. I&#8217;m by no means a testing expert, so please let me know if I&#8217;ve made mistakes or given bad advice.</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-05-12" pubdate>2010-05-12</time>
  
  <h1><a href="/2010/5/Spying-Constructors-in-JavaScript">Spying Constructors in JavaScript</a></h1>
</header>
  <div class="span-17 last entry">
    <p>When writing unit-tests for code, a common technique is <strong>spying</strong>, where you set expectations on a method&#8217;s invocation, run some code, and verify that the method was invoked as expected. This is pretty straightforward. Here&#8217;s a simple example using <a href='http://jsmockito.org/'>JsMockito</a>:</p>

<pre><code>function foo(a) { return a; }
foo = spy(foo);
foo(1);
verify(foo)(1); // verified!
verify(foo)(2); // never run</code></pre>

<p>Here, we&#8217;re spying on the <code>foo</code> method, and checking that it was invoked at least once with the parameter <code>1</code>, and once with the parameter <code>2</code>. As it turns out, this <code>spy</code> method does not work well with JavaScript constructors, in <a href='http://jsmockito.org/'>JsMockito</a>, <a href='http://github.com/pivotal/jasmine'>Jasmine</a>, or many other testing frameworks. The basic problem is that the prototype is not transferred appropriately, so code like this will fail:</p>

<pre><code>function Foo(a) {
	this.a = a;
}
Foo.prototype = {
	bar: function () {
		console.log(this.a);
	}
};

var f = new Foo(1);
f.bar(); // 1

Foo = spy(Foo);
var g = new Foo(1);
g.bar(); // error

verify(Foo)(1); // not reached</code></pre>

<p>It turns out it&#8217;s really easy to write a constructor-safe spying function, and it doesn&#8217;t even take very many lines of code.</p>

<pre><code>function spy(F) {
	function G() {
		var args = Array.prototype.slice.call(arguments);
		G.calls.push(args);
		F.apply(this, args);
	}

	G.prototype = F.prototype;
	G.calls = [];

	return G;
}</code></pre>

<p>This <code>spy</code> function works just like the one in JsMockito, but it doesn&#8217;t fail with constructors. For completeness, here&#8217;s an implementation of a simple <code>verify</code> function:</p>

<pre><code>function verify(F) {
	return function () {
		var args = Array.prototype.slice.call(arguments),
			i,
			j,
			call,
			count = 0,
			matched;

		for (i = 0; i &lt; F.calls.length; i += 1) {
			call = F.calls[i];
			matched = true;
			for (j = 0; j &lt; args.length; j += 1) {
				if (args[j] !== call[j]) {
					matched = false;
					break;
				}
			}
			if (matched) {
				count += 1;
			}
		}

		return count &gt; 0;
	};
}</code></pre>

<p>It would be easy to extend this <code>verify</code> implementation to allow more types of verify like <code>.once()</code> or <code>.never()</code>, working off the <code>count</code> variable.</p>

<p>And that&#8217;s it! Here&#8217;s an example of code that will work with this <code>spy</code> implementation:</p>

<pre><code>function Foo(name, id) {
	this.name = name;
	this.id = id;
}

Foo.prototype = {
	log: function () {
		console.log(&quot;Foo %o:%o&quot;, this.id, this.name);
	}
};

var f = new Foo(&quot;test&quot;, 1);
f.log();

Foo = spy(Foo);

var f2 = new Foo(&quot;spied&quot;, 2);
f2.log();

console.log(&quot;verify Foo(\&quot;spied\&quot;, 2): %o&quot;, verify(Foo)(&quot;spied&quot;, 2));
console.log(&quot;verify Foo(\&quot;something\&quot;, 2): %o&quot;, verify(Foo)(&quot;something&quot;, 2));

var baz = {
	spam: function (a) {
		console.log(&quot;calling baz.spam(%o), this.other=%o&quot;, a, this.other);
	},
	other: 10
};

baz.spam = spy(baz.spam);

baz.spam(1);
console.log(&quot;verify baz.spam(1)&quot;, verify(baz.spam)(1));
console.log(&quot;verify baz.spam(2)&quot;, verify(baz.spam)(2));</code></pre>

<p>The other neat thing is that, so long as you&#8217;re not trapping stale references to the original constructor function before it got spied, JavaScript&#8217;s <code>instanceof</code> operator should work just fine:</p>

<pre><code>function F() {}
F = spy(F)
new F() instanceof F; // true</code></pre>

<p>You can find the complete code (and a bit more) for this excercise at <a href='http://www.bcherry.net/playground/spying-constructors'>www.bcherry.net/playground/spying-constructors</a>. I hope this was informative. I think I&#8217;ll probably end up either contributing a patch to JsMockito with this, or building my own bare-bones set of mocking/spying functions for use with <a href='http://docs.jquery.com/QUnit'>QUnit</a>.</p>

<p><span class='note'>___P.S. It's been some time since I've updated, but I'm hoping this will be the first of many new, interesting JavaScript posts inspired by the work I'm doing at Twitter with @bs, @hoverbird, @ded, and @dsa.___</span></p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-04-13" pubdate>2010-04-13</time>
  
  <h1><a href="/2010/4/Debugging-Closures-and-Modules">Debugging Closures and Modules</a></h1>
</header>
  <div class="span-17 last entry">
    <p>The most common complaint with using closures to keep private variables in JavaScript is that it makes debugging harder. This complaint definitely holds water, and the loss of easy debugging and inspection using the <a href='http://www.adequatelygood.com/2010/3/JavaScript-Module-Pattern-In-Depth'>Module Pattern</a> is a serious concern. This is where one of JavaScript&#8217;s non-standard but well-supported features comes in: the <strong>debugger statement</strong>. In this article, I&#8217;ll introduce this statement, and show how I use it to solve this deficiency in closure-based code.</p>

<h2 id='intro_to_'>Intro to <code>debugger</code></h2>

<p>The <code>debugger</code> statement is not standardized, but <strong>is provided by all implementations</strong> of JavaScript. It essentially acts like a programmatic breakpoint. When popular JavaScript debuggers like Firebug or the IE Developer Tools execute a <code>debugger;</code> statement, execution stops and the script debugger opens up, just like any breakpoint. Here&#8217;s a simple example:</p>

<pre><code>function foo() {
	var a = 1;
	debugger; // execution stops until manually resumed
	a = 2;
}
foo();</code></pre>

<p>In the above, we&#8217;ll be able to inspect the local variables when our debugger pauses execution, and we&#8217;ll see that <code>a</code> is still <code>1</code>. After resuming execution, the next line will execute and <code>a</code> will be assigned the value <code>2</code>.</p>

<h2 id='debugging_modules'>Debugging Modules</h2>

<p>The great thing is that execution stops at the <code>debugger</code> statement, complete with the local call stack from the point of execution. This provides a really nice ability to pair with the module pattern, or any other closure-based privacy pattern. Let&#8217;s take a simple module, but add extra capabilities to it by exposing a public <code>.debug()</code> method.</p>

<pre><code>var foo = (function () {
	var privateVar = 10;
	return {
		publicFunc: function () {/*...*/},
		debug: function () {
			debugger;
		}
	};
}());</code></pre>

<p>Now we can call <code>foo.debug()</code> from the Firebug console, and the closure of the anonymous constructor is opened up for inspection. By looking at the <strong>call stack</strong> in our debugger, we can inspect the <strong>scope chain</strong> for the private state, which will be in local variables. Checking the value of <code>privateVar</code> will be quite easy.</p>

<p>Notice that it&#8217;s very important for the <code>.debug()</code> property to be created and assigned during the normal construction. Assigning it after-the-fact will not provide the same functionality, because the local call stack will not contain the anonymous constructor. This is an unfortunate limitation, but there isn&#8217;t a way around it.</p>

<h2 id='safety_and_configuration'>Safety and Configuration</h2>

<p>You might not want to make it so easy to stop program execution by triggering the <code>.debug()</code> function on one of your modules, or you might want to disable this functionality. One approach is to ship a version of your code without this property at all, but that&#8217;s difficult to accomplish in some applications. An easier method would be to do some extra checks in the <code>.debug()</code> method, before firing the <code>debugger</code> statement.</p>

<pre><code>return {
	debug: function () {
		if (DEBUG_MODE) {
			debugger;
		}
	}
};</code></pre>

<p>Or, perhaps check for a specific debugger first:</p>

<pre><code>return {
	debug: function () {
		if (DEBUG_MODE &amp;&amp; &quot;firebug&quot; in console) {
			debugger;
		}
	}
};</code></pre>
<span class='note'>___Note___: I'm assuming you've already configured a global flag named `DEBUG_MODE` in your application.</span>
<p>Methods like this will allow you to provide finer-grained control over when and where your <code>debugger</code> statement runs. If you&#8217;re building in a lot of logic, it makes sense to write a global helper function for this, but you&#8217;ll have to be careful to preserve the right call stack:</p>

<pre><code>function DEBUG() {
	if (DEBUG_MODE &amp;&amp; &quot;firebug&quot; in console) {
		debugger;
	}
}

var foo = (function () {
	return {
		debug: function () {
			DEBUG();
		}
	};
}());</code></pre>

<p>Here we&#8217;ll keep our callstack in tact, except the one we care about will be two deep instead of one deep.</p>

<h3 id='problems_with_minifiers'>Problems With Minifiers</h3>

<p>I tried running code with such a <code>.debug()</code> method through the YUI Compressor, and got a disappointing result:</p>

<pre><code>[ERROR] 4:11:identifier is a reserved word</code></pre>

<p>It seems that the YUI Compressor doesn&#8217;t know about the <code>debugger</code> statement, which is understandable since it&#8217;s non-standard. However, I didn&#8217;t want to let this defeat my attempts, so a co-worker and I came up with a workaround. Instead of using a raw <code>debugger</code> statement, we put it behind <code>eval</code>, like this:</p>

<pre><code>function debug() {
	eval(&#39;debugger;&#39;);
}</code></pre>

<p>Now YUI no longer complains, and the code works just great. However, there are a few caveats here:</p>

<ol>
<li>Using <code>eval</code> is generally considered <strong>dangerous</strong> and <strong>bad practice</strong>. Be sure you understand the implications, and are willing to use this workaround anyways. I think this is a reasonable decision to make, for the intended purpose, but ensure you&#8217;ve at least put some thought into it.</li>

<li>JSLint will complain at you. This isn&#8217;t such a big deal since it would be complaining about the raw <code>debugger</code> statement anyways.</li>
</ol>

<h2 id='conclusions'>Conclusions</h2>

<p>So that&#8217;s my technique for effectively debugging inside closures, especially when using the Module Pattern. I&#8217;m not saying this is a great technique for all uses or users, but it works well for me, and nicely solves the most common complaint developers have about the Module Pattern. I&#8217;d love to hear alternatives or reasons why my technique is dangerous and should be avoided, so leave a comment!</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-03-30" pubdate>2010-03-30</time>
  
  <h1><a href="/2010/3/Object-to-Primitive-Conversions-in-JavaScript">Object-to-Primitive Conversions in JavaScript</a></h1>
</header>
  <div class="span-17 last entry">
    <p>Like most object-oriented programming languages, JavaScript provides built-in ways to convert between objects and primitive values, by way of the special <code>toString</code> and <code>valueOf</code> methods. This article will cover the basics of these methods, but then dive into the details of how this stuff really works, bad stuff, performance, and browser support.</p>

<h3 id='types_and_primitives'>Types and Primitives</h3>

<p>To understand this article, you&#8217;ll need to understand the difference between <strong>primitive and non-primitive values</strong> in JavaScript. There are 5 primitive types, which are associated with the various primitive values.</p>

<ul>
<li><strong>Null</strong>: The value <code>null</code>.</li>

<li><strong>Undefined</strong>: The value <code>undefined</code>.</li>

<li><strong>Number</strong>: All numbers, such as <code>0</code> and <code>3.14</code>. Also <code>NaN</code>, and <code>Infinity</code>.</li>

<li><strong>Boolean</strong>: The values <code>true</code> and <code>false</code>.</li>

<li><strong>String</strong>: All strings, such as <code>&quot;foo&quot;</code> and <code>&quot;&quot;</code>.</li>
</ul>

<p>All other values are non-primitive, including arrays, functions, and plain old objects. For completeness, here are the results of the <code>typeof</code> operator, applied to these values:</p>

<pre><code>typeof null; // &quot;object&quot;
typeof undefined; // &quot;undefined&quot;
typeof 0; // &quot;number&quot; (`typeof NaN` is also &quot;number&quot;)
typeof true; // &quot;boolean&quot;
typeof &quot;foo&quot;; // &quot;string&quot;
typeof {}; // &quot;object&quot;
typeof function () {}; // &quot;function&quot;
typeof []; // &quot;object&quot;</code></pre>
<span class='note'>__Note__: `typeof null` should _not_ be `"object"`.  This is a mistake from the first versions of JavaScript, but it's really too late to fix.  A more sensible type would have been `"null"`, but this is what we're stuck with.</span>
<p>If you&#8217;ve got that down, then we&#8217;re ready to move on to the basics of <code>toString</code> and <code>valueOf</code>. If you&#8217;re already familiar with the basics, feel free to skip ahead to &#8220;How it Works&#8221;.</p>

<h2 id='basic_usage'>Basic Usage</h2>

<p>We&#8217;ll be using a simple example <code>population</code> object that holds a country name and a population. Lets code that up.</p>

<pre><code>function population(country, pop) {
	return {
		country: country,
		pop: pop
	};
}

var america_pop = population(&quot;USA&quot;, 350e6);
var mexico_pop = population(&quot;Mexico&quot;, 200e6);
var canada_pop = population(&quot;Canada&quot;, 200e6);

alert(america_pop); // [object Object]

var north_america_pop = america_pop + mexico_pop + canada_pop;

alert(north_america_pop); // [object Object][object Object][object Object]</code></pre>

<p>This works, but the calls to <code>alert</code> are not very useful. What we&#8217;d really like is for the first <code>alert</code> to show <code>&#39;[Population &quot;USA&quot; 350000000]&#39;</code> and the second to show <code>&quot;750000000&quot;</code>. So, let&#8217;s code that up next.</p>

<h3 id='tostring'>toString</h3>

<p>All objects inherit the method <code>toString</code> from <code>Object.prototype</code>, which returns <code>&quot;[object Object]&quot;</code>. However, we can easily override this by providing <code>toString</code> as a method of our object, or its prototype. In this example, we&#8217;ll attach it directly to each instance, but feel free to use the prototype instead.</p>

<pre><code>function population(country, pop) {
	return {
		country: country,
		pop: pop,
		
		toString: function () {
			return &quot;[Population &quot; + 
				&quot;\&quot;&quot; + country + &quot;\&quot; &quot; +
				pop +
			&quot;]&quot;;
		}
	}
}

var america_pop = population(&quot;USA&quot;, 350e6);
alert(america_pop); // [Population &quot;USA&quot; 350000000]</code></pre>
<span class='note'>__Note__: I'm using __closure__ on the `country` parameter, rather than using `this.country`.  This only works due to how the constructor is set up.  If you placed `toString` on the prototype, you would need to use `this.country`.</span>
<h3 id='valueof'>valueOf</h3>

<p>All JavaScript objects also inherit the method <code>valueOf</code> from <code>Object.prototype</code>. By default, this method simply returns the object itself, but is generally overridden to convert an object to a <code>Number</code>, or another primitive value, so it can be used by operators like <code>+</code>. We can do the same thing as above to complete our basic example.</p>

<pre><code>function population(country, pop) {
	return {
		country: country,
		pop: pop,
		
		toString: function () {
			return &quot;[Population &quot; + 
				&quot;\&quot;&quot; + country + &quot;\&quot; &quot; +
				pop +
			&quot;]&quot;;
		},
		
		valueOf: function () {
			return pop;
		}
	};
}

var america_pop = population(&quot;USA&quot;, 350e6);
var mexico_pop = population(&quot;Mexico&quot;, 200e6);
var canada_pop = population(&quot;Canada&quot;, 200e6);

alert(america_pop); // [Population &quot;USA&quot; 350000000

var north_america_pop = america_pop + mexico_pop + canada_pop;

alert(north_america_pop); // 750000000</code></pre>

<p>Here we&#8217;ve defined the <code>valueOf</code> function of our <code>population</code> object to return the population, which should be a <code>Number</code>.</p>

<h2 id='how_it_works'>How It Works</h2>

<p>As with most things in JavaScript, the process by which <code>toString</code> gets called is not as simple as you&#8217;d think. Let&#8217;s explore what happens when <code>alert(america_pop)</code> is called.</p>

<ol>
<li><code>alert</code> calls <code>GetValue</code> on the reference. This returns the object it points at.</li>

<li><code>alert</code> calls <code>ToString</code> on the value (this is <em>not</em> the same as the object&#8217;s <code>toString</code>)</li>

<li><code>ToString</code> calls <code>ToPrimitive</code> on the value, passing the <em>hint</em> <code>String</code>.</li>

<li><code>ToPrimitive</code> calls the object&#8217;s internal <code>[[DefaultValue]]</code> method with the <em>hint</em> <code>String</code>.</li>

<li><code>[[DefaultValue]]</code> calls the <code>toString</code> property of the object, with the object as <code>this</code>.</li>

<li>The result of <code>toString</code> is a primitive value, so it is returned, all the way up the chain to the <code>ToString</code> method.</li>

<li>Since the result is of type <code>String</code>, <code>ToString</code> returns all the way to <code>alert</code>.</li>

<li><code>alert</code> displays the value.</li>
</ol>

<p>While this is a lot, it&#8217;s pretty straightforward. However, he key mechanism that needs more explaining is the <code>ToPrimitive</code> function. This function is used to take an arbitrary value and get a corresponding primitive value instead. If the input is already a primitive value then the value will be returned without conversion. However, if the value is non-primitive, then it will call the internal <code>[[DefaultValue]]</code> method to find a <strong>default value</strong> for the object.</p>

<p><code>[[DefaultValue]]</code> is an internal property of every object. It&#8217;s a method that takes an optional <em>hint</em>, which should be either <code>Number</code> or <code>String</code>. If a <em>hint</em> is not provided, it will default to <code>Number</code> unless the object is a <code>Date</code>, in which case it defaults to <code>String</code> (this is silly). After this has been figured out, it will call <code>toString</code> and <code>valueOf</code>, in order, to find a primitive value. This is where the <em>hint</em> comes into play. If the <em>hint</em> is <code>Number</code>, then <code>valueOf</code> will be tried first, but if it&#8217;s <code>String</code> then <code>toString</code> will be tried first. Here&#8217;s the ensuing process:</p>

<ol>
<li>If the first method exists, and is callable, call it and get the result, otherwise skip to 3.</li>

<li>If the result of 1 is a primitive, return it.</li>

<li>If the second method exists, and is callable, call it and get the result, otherwise skip to 5.</li>

<li>If the result of 3 is a primitive, return it.</li>

<li>Throw a <code>TypeError</code> exception.</li>
</ol>

<p>The value that is returned by <code>[[DefaultValue]]</code> is guaranteed to be primitive. If it was not, a <code>TypeError</code> would have been thrown. This also implies that <code>toString</code> and <code>valueOf</code> should return primitives on order to be useful in this context.</p>

<h3 id='confusion_about_the__operator'>Confusion About the + Operator</h3>

<p>Here&#8217;s an example with a (possibly) unexpected result:</p>

<pre><code>var foo = {
	toString: function () {
		return &quot;foo&quot;;
	},
	valueOf: function () {
		return 5;
	}
};

alert(foo + &quot;bar&quot;); // 5bar
alert([foo, &quot;bar&quot;].join(&quot;&quot;)); // foobar</code></pre>

<p>In this context, we&#8217;re using the <code>+</code> operator to do string concatenation. But, <code>foo</code> was <em>not</em> converted to a string using <code>toString</code>, it was turned into a number using <code>valueOf</code>, then used for string concatenation. This probably isn&#8217;t what we want, but it is how it works. It&#8217;s a side-effect of the overloading of the <code>+</code> operator for arithmetic and string concatenation. The <code>+</code>operator has a well-defined process:</p>

<ol>
<li>Evaluate the left-hand side, and get the value.</li>

<li>Evaluate the right-hand side, and get the value.</li>

<li>Call <code>ToPrimitive</code> on both the left-hand and right-hand sides (without a <em>hint</em>)</li>

<li>If either primitive value is a <code>String</code>, then skip to 7.</li>

<li>Call <code>ToNumber</code> on both values.</li>

<li>Return the sum of the values.</li>

<li>Call <code>ToString</code> on both values.</li>

<li>Return the concatenation of both values.</li>
</ol>

<p>Since no <em>hint</em> is passed to the <code>ToPrimitive</code> calls, the <em>hint</em> will be defaulted to <code>Number</code> (unless it&#8217;s a <code>Date</code>, which defaults to <code>String</code>). This means that our <code>valueOf</code> function will be called, instead of <code>toString</code>. It&#8217;s not until <em>after</em> the primitive values are retrieved that the interpreter decides whether it is going to do string concatenation or arithmetic. That&#8217;s why our example above returns <code>&quot;5bar&quot;</code> instead of <code>&quot;foobar&quot;</code>.</p>

<h3 id='bad_stuff'>Bad Stuff</h3>

<p>There is one really bad feature of all this, which is that <code>ToPrimitive</code> does not enforce any type-checking on the return values, other than that they are primitive. This means you can write code like this:</p>

<pre><code>var foo = {
	toString: function () {
		return 5;
	},
	valueOf: function () {
		return &quot;foo&quot;;
	}
};
alert(foo.toString() + 1); // 6 (bad!)
alert(foo + 1); // &quot;foo1&quot; (no good!)
alert(+foo); // NaN (the worst!)</code></pre>

<p>The <code>valueOf</code> method can be forgiven for not type-checking, because it is more generic. You&#8217;d expect it to be able to return any suitable primitive value. However, the <code>toString</code> method has <em>no such excuse</em>. This is simply a bad feature. You can, of course, mitigate by using <code>String(foo)</code> instead of <code>foo.toString()</code>, which will call <code>toString</code> and then convert that result to a string. But you should not have to do this, or worry about this. Please do not make objects with <code>toString</code> methods that do not return strings.</p>

<h2 id='how_about_performance'>How About Performance?</h2>

<p>After understanding the complexity that goes into these implicit conversion, I got curious about how that affects performance. So I decided to test the time it takes to perform an <code>[].join(obj)</code> over 1,000,000 iterations in the major browsers. I did one test with the object being implicitly cast to a string, and one where I called the <code>toString</code> method manually (i.e. <code>[].join(obj.toString())</code>). As expected, the explicit call was faster in most cases.</p>

<ul>
<li><strong>Firefox 3.6.2</strong>: 874ms vs. 320ms - <strong>almost 3x faster</strong>.</li>

<li><strong>Chrome 5</strong>: 94ms vs. 47ms - <strong>2x faster</strong>.</li>

<li><strong>Opera 10.50</strong>: 155ms vs 182ms - <strong>a little slower</strong>.</li>

<li><strong>Safari 4</strong>: 409ms vs 280ms - <strong>almost 2x faster</strong>.</li>

<li><strong>Internet Explorer 8</strong>: 2856ms vs 2786ms - <strong>about the same</strong>.</li>

<li><strong>Internet Explorer 9</strong> (preview): 645ms vs 633ms - <strong>about the same</strong>.</li>
</ul>
<span class='note'>___Note 1___: The Firefox, Chrome, Opera, and Safari tests were all run on a Macbook Pro running OS X 10.5.  The IE tests were run on a desktop running Windows 7.  [Run the tests yourself here.](http://www.bcherry.net/playground/defaultvalues)</span><span class='note'>___Note 2___: I chose to use the `[].join` method because doing so was most likely to avoid any dead-code elimination optimizations in modern browsers.  I've had trouble with this before, in Firefox.  I _did_ try testing with the `String()` constructor, with similar results in most browsers.  Opera was an exception where using the explicit `toString` was close to __5x faster__.  In Firefox, the explicit cast was a bit faster, but both cases were about 100x faster than the `[].join` method (and other browsers), which means the code-path was probably being removed by the dead code eliminator.</span>
<p>The takeaway from this performance test is that it&#8217;s always best to call your object&#8217;s type-conversion methods directly, rather than relying on the interpreter to do the complex series of method calls and comparisons needed to do it automatically. The Opera 10.50 result is very strange, but it&#8217;s not particularly slower, so I wouldn&#8217;t worry about it. The gains made in other browsers more than make up for the outlier Opera result.</p>

<h2 id='how_about_browser_support'>How About Browser Support?</h2>

<p>Like many things in the ECMAScript specification, these processes are complex, and I doubted that all browsers would implement them exactly as specified. So, in that <a href='http://www.bcherry.net/playground/defaultvalues'>test suite from earlier</a>, I added compliance checks. I was quite surprised to see that all major browsers, including versions of Internet Explorer going back to at least IE 5.5, implement these mechanisms correctly. This is even the case with the awkward handling when developers do things like make <code>toString</code> return a number instead of a string. All browsers handle the code according to the specification. This is great news.</p>

<p>But the specification unhelpfully introduced ambiguity in one particular area: the absence of a <em>hint</em> for the <code>ToPrimitive</code> function. Here&#8217;s the exact wording:</p>

<blockquote>
<p>All native ECMAScript objects except Date objects handle the absence of a hint as if the hint Number were given; Date objects handle the absence of a hint as if the hint String were given. Host objects may handle the absence of a hint in some other manner.</p>
</blockquote>

<p>That the standard explicitly allows browsers to deviate here worried me. Included in that test suite was a check that, in the absence of a <em>hint</em>, <code>Date</code> objects will default to <code>String</code> and <code>Boolean</code> objects will default to <code>Number</code>. All browsers passed this check as well, which means that browser support for all of this functionality seems to be <strong>consistent</strong> and <strong>correct</strong>.</p>

<h2 id='conclusions'>Conclusions</h2>

<p>I hope this was useful in understanding how these mechanisms work in JavaScript. There are three important things to take away from this article:</p>

<ol>
<li>Implement <code>toString</code> and <code>valueOf</code> on your commonly-reused objects. They can help you write clearer, more concise code, and make debugging easier too.</li>

<li>All browsers implement object-to-primitive conversion according to the specification, so you can safely consult it for more detail.</li>

<li>When performance is important, always try to call your type-conversion methods directly, instead of relying on JavaScript&#8217;s implicit calls.</li>
</ol>

<p>You can find the <a href='http://www.bcherry.net/playground/defaultvalues'>test suite used for this article here</a> if you&#8217;re interested in trying to replicate my results. Please let me know if you find contradictory results to what I posted here.</p>

<p>Thanks for reading! If you have questions or feedback then leave a comment below or contact me directly.</p>
  </div>
</article>

  

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-03-21" pubdate>2010-03-21</time>
  
  <h1><a href="/2010/3/JavaScript-Better-and-Faster">JavaScript: Better and Faster</a></h1>
</header>
  <div class="span-17 last entry">
    <p>&#8220;JavaScript: Better and Faster&#8221; is the name of a presentation I gave at <a href='http://www.slide.com'>Slide</a> last week. It was generally well-received by the Slide crew so I decided to put a (slightly edited) copy of the <a href='http://www.bcherry.net/talks/js-better-faster'>accompanying slideshow online</a> (runs in your browser). It&#8217;s not particularly dense, and doesn&#8217;t get into too much depth on any one topic, but I think it gives a great practical overview of the JavaScript landscape, including what things to look out for and neat techniques to write better code. The original intent was to cover the ins and outs of writing good, efficient JavaScript, targeted at people who write JavaScript every day, but have a strong background in Python.</p>

<p>I&#8217;d like to give a huge thanks to <a href='http://scottchacon.com/'>Scott Chacon</a>, whose <a href='http://github.com/schacon/showoff'>Showoff</a> software made compiling this slideshow the most enjoyable thing imaginable. It took a little work to port the resultant slideshow to Google AppEngine, but I got it up and running. I&#8217;ll probably work on a more generalized Python/AppEngine adaptation of Showoff for my future use, since that&#8217;s my web platform and I want to keep using Showoff in the future. This experience also got me really turned on to <a href='http://daringfireball.net/projects/markdown/'>Markdown</a>, which I wasted no time in integrating into this blog.</p>

<p>This is the first presentation I&#8217;ve given in my professional career, and would much appreciate feedback on the slides.</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-03-12" pubdate>2010-03-12</time>
  
  <h1><a href="/2010/3/JavaScript-Module-Pattern-In-Depth">JavaScript Module Pattern: In-Depth</a></h1>
</header>
  <div class="span-17 last entry">
    <p>The module pattern is a common JavaScript coding pattern. It&#8217;s generally well understood, but there are a number of advanced uses that have not gotten a lot of attention. In this article, I&#8217;ll review the basics and cover some truly remarkable advanced topics, including one which I think is original.</p>

<h2 id='the_basics'>The Basics</h2>

<p>We&#8217;ll start out with a simple overview of the module pattern, which has been well-known since Eric Miraglia (of YUI) first <a href='http://yuiblog.com/blog/2007/06/12/module-pattern/'>blogged about it</a> three years ago. If you&#8217;re already familiar with the module pattern, feel free to skip ahead to &#8220;Advanced Patterns&#8221;.</p>

<h3 id='anonymous_closures'>Anonymous Closures</h3>

<p>This is the fundamental construct that makes it all possible, and really is the single <strong>best feature of JavaScript</strong>. We&#8217;ll simply create an anonymous function, and execute it immediately. All of the code that runs inside the function lives in a <strong>closure</strong>, which provides <strong>privacy</strong> and <strong>state</strong> throughout the lifetime of our application.</p>

<pre><code>(function () {
	// ... all vars and functions are in this scope only
	// still maintains access to all globals
}());</code></pre>

<p>Notice the <code>{@class=js inline}()</code> around the anonymous function. This is required by the language, since statements that begin with the token <code>{@class=js inline}function</code> are always considered to be <strong>function declarations</strong>. Including <code>{@class=js inline}()</code> creates a <strong>function expression</strong> instead.</p>

<h3 id='global_import'>Global Import</h3>

<p>JavaScript has a feature known as <strong>implied globals</strong>. Whenever a name is used, the interpreter walks the scope chain backwards looking for a <code>{@class=js inline}var</code> statement for that name. If none is found, that variable is assumed to be global. If it&#8217;s used in an assignment, the global is created if it doesn&#8217;t already exist. This means that using or creating global variables in an anonymous closure is easy. Unfortunately, this leads to hard-to-manage code, as it&#8217;s not obvious (to humans) which variables are global in a given file.</p>

<p>Luckily, our anonymous function provides an easy alternative. By passing globals as parameters to our anonymous function, we <strong>import</strong> them into our code, which is both <strong>clearer</strong> and <strong>faster</strong> than implied globals. Here&#8217;s an example:</p>

<pre><code>(function ($, YAHOO) {
	// now have access to globals jQuery (as $) and YAHOO in this code
}(jQuery, YAHOO));</code></pre>

<h3 id='module_export'>Module Export</h3>

<p>Sometimes you don&#8217;t just want to <em>use</em> globals, but you want to <em>declare</em> them. We can easily do this by exporting them, using the anonymous function&#8217;s <strong>return value</strong>. Doing so will complete the basic module pattern, so here&#8217;s a complete example:</p>

<pre><code>var MODULE = (function () {
	var my = {},
		privateVariable = 1;

	function privateMethod() {
		// ...
	}

	my.moduleProperty = 1;
	my.moduleMethod = function () {
		// ...
	};

	return my;
}());</code></pre>

<p>Notice that we&#8217;ve declared a global module named <code>{@class=js inline}MODULE</code>, with two public properties: a method named <code>{@class=js inline}MODULE.moduleMethod</code> and a variable named <code>{@class=js inline}MODULE.moduleProperty</code>. In addition, it maintains <strong>private internal state</strong> using the closure of the anonymous function. Also, we can easily import needed globals, using the pattern we learned above.</p>

<h2 id='advanced_patterns'>Advanced Patterns</h2>

<p>While the above is enough for many uses, we can take this pattern farther and create some very powerful, extensible constructs. Lets work through them one-by-one, continuing with our module named <code>{@class=js inline}MODULE</code>.</p>

<h3 id='augmentation'>Augmentation</h3>

<p>One limitation of the module pattern so far is that the entire module must be in one file. Anyone who has worked in a large code-base understands the value of splitting among multiple files. Luckily, we have a nice solution to <strong>augment modules</strong>. First, we import the module, then we add properties, then we export it. Here&#8217;s an example, augmenting our <code>{@class=js inline}MODULE</code> from above:</p>

<pre><code>var MODULE = (function (my) {
	my.anotherMethod = function () {
		// added method...
	};

	return my;
}(MODULE));</code></pre>

<p>We use the <code>{@class=js inline}var</code> keyword again for consistency, even though it&#8217;s not necessary. After this code has run, our module will have gained a new public method named <code>{@class=js inline}MODULE.anotherMethod</code>. This augmentation file will also maintain its own private internal state and imports.</p>

<h3 id='loose_augmentation'>Loose Augmentation</h3>

<p>While our example above requires our initial module creation to be first, and the augmentation to happen second, that isn&#8217;t always necessary. One of the best things a JavaScript application can do for performance is to load scripts asynchronously. We can create flexible multi-part modules that can load themselves in any order with <strong>loose augmentation</strong>. Each file should have the following structure:</p>

<pre><code>var MODULE = (function (my) {
	// add capabilities...

	return my;
}(MODULE || {}));</code></pre>

<p>In this pattern, the <code>{@class=js inline}var</code> statement is always necessary. Note that the import will create the module if it does not already exist. This means you can use a tool like <a href='http://labjs.com/'>LABjs</a> and load all of your module files in parallel, without needing to block.</p>

<h3 id='tight_augmentation'>Tight Augmentation</h3>

<p>While loose augmentation is great, it does place some limitations on your module. Most importantly, you cannot override module properties safely. You also cannot use module properties from other files during initialization (but you can at run-time after intialization). <strong>Tight augmentation</strong> implies a set loading order, but allows <strong>overrides</strong>. Here is a simple example (augmenting our original <code>{@class=js inline}MODULE</code>):</p>

<pre><code>var MODULE = (function (my) {
	var old_moduleMethod = my.moduleMethod;

	my.moduleMethod = function () {
		// method override, has access to old through old_moduleMethod...
	};

	return my;
}(MODULE));</code></pre>

<p>Here we&#8217;ve overridden <code>{@class=js inline}MODULE.moduleMethod</code>, but maintain a reference to the original method, if needed.</p>

<h3 id='cloning_and_inheritance'>Cloning and Inheritance</h3>

<pre><code>var MODULE_TWO = (function (old) {
	var my = {},
		key;

	for (key in old) {
		if (old.hasOwnProperty(key)) {
			my[key] = old[key];
		}
	}

	var super_moduleMethod = old.moduleMethod;
	my.moduleMethod = function () {
		// override method on the clone, access to super through super_moduleMethod
	};

	return my;
}(MODULE));</code></pre>

<p>This pattern is perhaps the <strong>least flexible</strong> option. It does allow some neat compositions, but that comes at the expense of flexibility. As I&#8217;ve written it, properties which are objects or functions will <em>not</em> be duplicated, they will exist as one object with two references. Changing one will change the other. This could be fixed for objects with a recursive cloning process, but probably cannot be fixed for functions, except perhaps with <code>{@class=js inline}eval</code>. Nevertheless, I&#8217;ve included it for completeness.</p>

<h3 id='crossfile_private_state'>Cross-File Private State</h3>

<p>One severe limitation of splitting a module across multiple files is that each file maintains its own private state, and does not get access to the private state of the other files. This can be fixed. Here is an example of a loosely augmented module that will <strong>maintain private state</strong> across all augmentations:</p>

<pre><code>var MODULE = (function (my) {
	var _private = my._private = my._private || {},
		_seal = my._seal = my._seal || function () {
			delete my._private;
			delete my._seal;
			delete my._unseal;
		},
		_unseal = my._unseal = my._unseal || function () {
			my._private = _private;
			my._seal = _seal;
			my._unseal = _unseal;
		};

	// permanent access to _private, _seal, and _unseal

	return my;
}(MODULE || {}));</code></pre>

<p>Any file can set properties on their local variable <code>{@class=js inline}_private</code>, and it will be immediately available to the others. Once this module has loaded completely, the application should call <code>{@class=js inline}MODULE._seal()</code>, which will prevent external access to the internal <code>{@class=js inline}_private</code>. If this module were to be augmented again, further in the application&#8217;s lifetime, one of the internal methods, in any file, can call <code>{@class=js inline}_unseal()</code> before loading the new file, and call <code>{@class=js inline}_seal()</code> again after it has been executed. This pattern occurred to me today while I was at work, I have not seen this elsewhere. I think this is a very useful pattern, and would have been worth writing about all on its own.</p>

<h3 id='submodules'>Sub-modules</h3>

<p>Our final advanced pattern is actually the simplest. There are many good cases for creating sub-modules. It is just like creating regular modules:</p>

<pre><code>MODULE.sub = (function () {
	var my = {};
	// ...

	return my;
}());</code></pre>

<p>While this may have been obvious, I thought it worth including. Sub-modules have all the advanced capabilities of normal modules, including augmentation and private state.</p>

<h2 id='conclusions'>Conclusions</h2>

<p>Most of the advanced patterns can be combined with each other to create more useful patterns. If I had to advocate a route to take in designing a complex application, I&#8217;d combine <strong>loose augmentation</strong>, <strong>private state</strong>, and <strong>sub-modules</strong>.</p>

<p>I haven&#8217;t touched on performance here at all, but I&#8217;d like to put in one quick note: The module pattern is <strong>good for performance</strong>. It minifies really well, which makes downloading the code faster. Using <strong>loose augmentation</strong> allows easy non-blocking parallel downloads, which also speeds up download speeds. Initialization time is probably a bit slower than other methods, but worth the trade-off. Run-time performance should suffer no penalties so long as globals are imported correctly, and will probably gain speed in sub-modules by shortening the reference chain with local variables.</p>

<p>To close, here&#8217;s an example of a sub-module that loads itself dynamically to its parent (creating it if it does not exist). I&#8217;ve left out private state for brevity, but including it would be simple. This code pattern allows an entire complex heirarchical code-base to be loaded completely in parallel with itself, sub-modules and all.</p>

<pre><code>var UTIL = (function (parent, $) {
	var my = parent.ajax = parent.ajax || {};

	my.get = function (url, params, callback) {
		// ok, so I&#39;m cheating a bit :)
		return $.getJSON(url, params, callback);
	};

	// etc...

	return parent;
}(UTIL || {}, jQuery));</code></pre>

<p>I hope this has been useful, and please leave a comment to share your thoughts. Now, go forth and write better, more modular JavaScript!</p>

<p><strong><em>This post was <a href='http://ajaxian.com/archives/a-deep-dive-and-analysis-of-the-javascript-module-pattern'>featured on Ajaxian.com</a>, and there is a little bit more discussion going on there as well, which is worth reading in addition to the comments below.</em></strong></p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-03-08" pubdate>2010-03-08</time>
  
  <h1><a href="2010/3/Performance-of-vs-">Performance of === vs. ==</a></h1>
</header>
  <div class="span-17 last entry">
    <p>One particular weirdness and unpleasantry in JavaScript is the set of equality operators. Like virtually every language, JavaScript has the standard <code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, and <code>&gt;=</code> operators. However, <code>==</code> and <code>!=</code> are NOT the operators most would think they are. These operators do <strong>type coercion</strong>, which is why <code>[0] == 0</code> and <code>&quot;\n0\t &quot; == 0</code> both evaluate to <code>true</code>. This is considered, by sane people, to be a <strong>bad thing</strong>. Luckily, JavaScript does provide a normal set of equality operators, which do what you expect: <code>===</code> and <code>!==</code>. It sucks that we need these at all, and <code>===</code> is a pain to type, but at least <code>[0] !== 0</code>.</p>

<p>So, that&#8217;s all well and good, but when making the decision to use <code>===</code> instead of <code>==</code> it&#8217;s important to understand if there are any performance implications. Reasonable people, like myself, would expect the strict equality operators to be faster than their type-coercing counterparts, because the type coercion must take time. But, being <a href='http://xkcd.com/242/'>a scientist</a>, I had to set up an experiment to test this hypothesis.</p>

<h2 id='for_science'>For Science!</h2>

<p><a href='http://www.bcherry.net/playground/comparisons'>My experiment</a> times the execution time of 24 different tests, in the browser you view it in. These tests represent every permutation of the following factors:</p>

<ol>
<li><strong>Use</strong>: Whether the result is computed and thrown away, or assigned into a local variable.</li>

<li><strong>Comparison</strong>: Comparing integers vs. integers, strings vs. strings, and integers vs. strings.</li>

<li><strong>Operands</strong>: Whether the operands are actually equal or unequal (with forced type coercion in the case of <code>===</code>).</li>

<li><strong>Operator</strong>: Using either <code>==</code> or <code>===</code>.</li>
</ol>

<p>Note that I am specifically <strong>not</strong> testing the relative performance when comparing against values like <code>null</code>, <code>undefined</code>, or <code>false</code>. This is because those are falsy values which have even worse type coercion characteristics. Some integers and strings can, of course, also be falsy, such as <code>0</code> or <code>&quot;&quot;</code>, but these are normal values which occur during arithmetic or string comparison, so I&#8217;ve tested with them.</p>

<p>The tests were run over two million iterations, except in Internet Explorer, where it produced a long-running script error, so I cut it to 500,000 iterations. Here are the browser configurations I tested:</p>

<ol>
<li>Mozilla Firefox 3.6 (Mac)</li>

<li>Google Chrome 5 (Mac dev channel)</li>

<li>Internet Explorer 8 (iterations reduced by 4x)</li>

<li>Safari 4 (Mac)</li>

<li>Opera 10.5 beta (Mac)</li>

<li>Mozilla Firefox 3.6 (Mac) with Firebug open</li>
</ol>

<h2 id='results'>Results</h2>

<p>My results are <a href='http://spreadsheets.google.com/pub?key=taW8f6kvj3kUVObtg4p9vqQ&amp;output=html'>available as a Google spreadsheet here</a>. It turns out that there is little practical performance difference between <code>==</code> and <code>===</code>. While the strict operator is marginally faster (roughly 10%) in most browsers when combined with explicit type conversion, such as <code>a === +b</code>, the only real performance gains will come from avoiding type conversion entirely. <strong>Converting a string to an integer for comparison with another integer is significantly slower (up to 10x) than simple comparing two integers</strong>. You should never allow integers to be stored as strings internally, as the type conversion will incur a performance penalty.</p>

<p>While that was the basic takeaway from the numbers, I did find one interesting outlier when testing with Firefox. In Firefox, the comparison <code>a === +b</code> is about 20x slower than the equivalent <code>a == b</code> when <code>a</code> is an integer and <code>b</code> is a string integer. This result seems suspicious to me, and nothing similar occurred in any other browser. Oddly, when the Firebug script debugger is turned on, this result changes, and <code>a === +b</code> becomes about 10% faster than the other. I&#8217;m not sure what to make of this result, but it does serve as a reminder that integers should always be stored in numbers, not in strings.</p>

<h2 id='conclusion'>Conclusion</h2>

<p>Not much surprise in these results, other than the Firefox result. But, it did help me avoid a nagging worry that I&#8217;m silently slowing down my code whenever I use <code>===</code> instead of <code>==</code> in my JavaScript.</p>

<p>Again, find the test <a href='http://www.bcherry.net/playground/comparisons'>here</a> and my results <a href='http://spreadsheets.google.com/pub?key=taW8f6kvj3kUVObtg4p9vqQ&amp;output=html'>here</a>. I hope you found this information interesting. Let me know in the comments if you see different results than I got.</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-02-26" pubdate>2010-02-26</time>
  
  <h1><a href="/2010/2/Minimum-Timer-Intervals-in-JavaScript">Minimum Timer Intervals in JavaScript</a></h1>
</header>
  <div class="span-17 last entry">
    <p>I was talking with a co-worker today about the behavior of <code>setTimeout</code> and <code>setInterval</code> when given a small interval, like <code>0</code> or <code>1</code>. The <em>expectation</em> would be that the timer will fire in 0ms, or 1ms. However, as with <a href='http://wtfjs.com' target='_blank'>other things</a> in JavaScript, the <em>reality</em> is a bit different. It turns out that browsers actually have a <strong>minimum timer interval</strong> which they can&#8217;t work any faster than. John Resig wrote about <a href='http://ejohn.org/blog/analyzing-timer-performance/' target='_blank'>timer performance</a> a few years back, and found this behavior. He&#8217;s also covering it in more detail in his new book.</p>

<p>But, I wasn&#8217;t happy with data a few years old, so I decided to just go and write my own simple test suite, <a href='http://www.bcherry.net/playground/settimeout' target='_blank'>How Fast is setTimeout in Your Browser?</a>. This page simply runs <code>setTimeout</code> with an interval of 0, 1000 times, and averages the <em>real</em> timeout experienced in each. Go ahead and check it out in your browser of choice.</p>

<h2 id='the_results'>The Results</h2>

<p>Well, it turns out that things aren&#8217;t so bad. Most browsers are in the <strong>10-15ms</strong> range for their bottom limit, having improved in recent versions. Notable exceptions are Internet Explorer, which has the same bottom of around <strong>16ms</strong> in all versions since IE6, and Google Chrome, which, at least since version 4, has a bottom limit closer to <strong>5ms</strong> It&#8217;s important to keep this limitation in mind when using <code>setTimeout</code> or <code>setInterval</code>. In particular, if you&#8217;re looking for consistent timer intervals across browsers, you have to use something <strong>&gt;15ms</strong>. But, don&#8217;t forget that JavaScript is single-threaded, and the timer won&#8217;t execute while other code is executing. This means that in the following code sample, you can guarantee that the timer <strong>will not run</strong> until the loop has completed. You cannot, however, guarantee precisely when that will happen, nor that it will be the next piece of code to run following the loop.</p>

<pre><code>setTimeout(function () { alert(&quot;timer&quot;); }, 0);
for (var i = 0; i &lt; 1000; i += 1) {
	// something
}</code></pre>

<p>So it should be safe to use timers with an interval of 0ms when your only expectation is that the timer will fire as soon as it can, but not until after the current code path has completed. Relying on timers to respect the interval you give them is foolish, since, as I&#8217;ve shown, they have a lower-bound, and since they wait even after firing, before executing, for other code to return.</p>

<h2 id='the_source_code'>The Source Code</h2>

<p>This test is really simple. Here&#8217;s the complete JavaScript source code:</p>

<pre><code>var target = document.getElementById(&quot;target&quot;),
	results = 0,
	iterations = 1000,
	i = 0;

function go() {
	var fn = function () {
			results += new Date().getTime() - d;
			i += 1;
			if (i &lt; iterations) {
				go();
			} else {
				finish();
			}
		},
		d = new Date().getTime();
	setTimeout(fn, 0);
}

function finish() {
	target.innerHTML = &quot;Average timer delay was &lt;span class=\&quot;num\&quot;&gt;&quot; + results/iterations + 
		&quot;&lt;/span&gt;ms, over &lt;span class=\&quot;num\&quot;&gt;&quot; + iterations + &quot;&lt;/span&gt; iterations.&quot;;
}

go();</code></pre>

<p>And that&#8217;s all there is to it. I hope you found this useful or interesting. Timers are very fickle, but also incredibly useful, so it&#8217;s worth taking the time to understand what it is they do, and how they do it.</p>
  </div>
</article>

  

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-02-12" pubdate>2010-02-12</time>
  
  <h1><a href="/2010/2/Finding-Improper-JavaScript-Globals">Finding Improper JavaScript Globals</a></h1>
</header>
  <div class="span-17 last entry">
    <p>When I interview web developers, my first JavaScript question is usually the following:</p>
<blockquote>What is the difference, in JavaScript, between <code class="js inline">x = 1</code> and <code class="js inline">var x = 1</code>.  Feel free to answer in as much or as little detail as you feel comfortable.</blockquote>
<p>Most people would give an answer about how the <code class="js inline">var</code> keyword makes something a local variable, omitting it makes it a global variable.  While I'd love to hear about scope chains, the window object, and hear the term "implied global" in an answer, that basic answer is good enough.  It might not show a thorough knowledge of JavaScript, but at least it shows some level of understanding of the most common dangerous feature.</p>
<p>There are three basic ways to make a global variable in JavaScript.  You can use <code class="js inline">var</code> (<strong>declared global</strong>), you can just assign to it without having declared it (<strong>implied global</strong>), or you can set a property on the <code class="js inline">window</code> object (<strong>window global</strong>).  Here's those three:</p>
<pre class="js">var x = 1; // declared global
y = 2; // implied global
window.z = 3; // window global</pre>
<p>Implied globals are bad because they're hard to keep track of, and their declarations aren't <a href="http://www.adequatelygood.com/2010/2/JavaScript-Scoping-and-Hoisting">hoisted</a>.  I don't like window globals either, because mixing <code class="js inline">window.x</code> and <code class="js inline">x</code> is bad form.  In my opinion, <strong>all globals should be declared globals</strong>.  Unfortunately, JavaScript makes this really hard to maintain.  There are tools like <a href="http://www.jslint.com/">JSLint</a> that will perform analysis of your code and help you out, but it can't do an entire code base at once, at least not easily.</p>
<p>I've written a tool that performs <strong>run-time analysis</strong> of your application, and finds all of the improperly declared globals (both implied and window globals).  Check out a demo <a href="http://www.bcherry.net/badglobals">here</a>.</p>
<h2>Introducing badglobals.js</h2>
<p><a href="http://www.bcherry.net/static/lib/js/badglobals.js">badglobals.js</a> is a tool for finding all of the improperly declared global variables in your application.  Using it is simple, but don't use it in production code (see "How It Works" below).</p>
<ol>
	<li>Include <a href="http://www.bcherry.net/static/lib/js/badglobals.js">badglobals.js</a> in your page, before any other scripts.</li>
	<li>When you want to do analysis, open Firebug and run <code class="js inline">BADGLOBALS.check()</code>.</li>
	<li>You'll see a warning statement in the console for every bad global found.  These contain both the name, and the value.</li>
</ol>
<p>In addition, there are a few slightly more advanced features you might be interested in.</p>
<h3>Exclusions</h3>
<p>If you have some globals you don't want to be reported about (such as third-party libraries), you can easily exclude them manually.  Before you run the check, just call <code class="js inline">.exclude</code>, like so:</p>
<pre class="js">BADGLOBALS.exclude("jQuery", "$", "YAHOO");</pre>
<p>Feel free to call this method as many times as you'd like, it always adds, and never removes.  By default, all browser built-ins are excluded (these are found when the script is included).  Sometimes, the variable <code class="js inline">_firebug</code> enters after the script include, and shows in the report.  You should exclude this.</p>
<h3>Report Object</h3>
<p>While the warnings are probably enough, badglobals.js also builds a report object, containing more information.  Access it by calling <code class="js inline">BADGLOBALS.report()</code>.  This will run <code class="js inline">.check()</code> if it has not run already.  The report object has the following properties:</p>
<ul>
	<li><strong>bad:</strong> An array of the names of the bad globals found.</li>
	<li><strong>good:</strong> An array of the names of the good globals found.</li>
	<li><strong>skipped:</strong> An array of the names of the globals that were not checked.</li>
</ul>
<p>And that's all there is to badglobals.js.  It's really simple to use, but remarkably effective.</p>
<h2>How It Works</h2>
<p>badglobals.js works because of one key difference between implied/window globals and declared globals:  <strong>declared globals cannot be deleted</strong>.  This is because using <code class="js inline">var</code> causes the internal property [[DontDelete]] to be set.</p>
<pre class="js">var x = 1;
y = 2;
window.z = 3;

delete x; // false
delete y; // true
delete z; // true

x; // 1
y; // undefined
z; // undefined</pre>
<p>badglobals.js simply tries to delete every property of window (skipping the built-ins, of course).  If the delete succeeds, it was declared wrong.  It always puts it back, but I wouldn't trust this to run in production code, because it just <em>seems dangerous</em>.  Here's the core section of badglobals.js:</p>
<pre class="js">for (prop in window) {
	if (window.hasOwnProperty(prop)) {
		if (skip.indexOf(prop) >= 0 || exclude.indexOf(prop) >= 0) {
			skipped.push(prop);
		} else {
			val = window[prop];
			if (delete window[prop]) {
				console.warn("Found non-var global %o with value %o", prop, val);
				bad.push(prop);
				try {
					window[prop] = val;
				} catch (e) {
					console.error("Oops, there was an error putting %o back :(", prop);
				}
			} else {
				good.push(prop);
			}
		}
	}
}</pre>
<h3>Browser Support</h3>
<p>This script will not work in Internet Explorer, because I use the array <code class="js inline">indexOf</code> method, among other things.  I also think IE doesn't exactly follow the standard when it comes to <code class="js inline">delete</code>, so the checks might not work.  I don't consider this a problem, because this is a <strong>developer tool</strong>, not production code.  You'll find the complete set of bad globals with Firefox or Chrome, so you should not need to check in Internet Explorer as well.  I have not tested it in Opera, but the <code class="js inline">console</code> references will certainly fail.</p>
<h3>Thanks to...</h3>
<p>I got the idea for this tool from the <a href="http://perfectionkills.com/understanding-delete/">excellent article</a> on <code class="js inline">delete</code> by kangax, over at <a href="http://perfectionkills.com">his blog</a>.  If you haven't read that article, you really should.  The depth and quality is incredible.</p>
<h2>Get badglobals.js</h2>
<p>Here are the links, one more time:</p>
<ul>
	<li><a href="http://www.bcherry.net/static/lib/js/badglobals.js">Raw Script</a></li>
	<li><a href="http://github.com/bcherry/bcherry/blob/master/bcherry-web/static/lib/js/badglobals.js">Script at GitHub</a></li>
	<li><a href="http://www.bcherry.net/badglobals">Demo Page</a></li>
</ul>

  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-02-08" pubdate>2010-02-08</time>
  
  <h1><a href="/2010/2/JavaScript-Scoping-and-Hoisting">JavaScript Scoping and Hoisting</a></h1>
</header>
  <div class="span-17 last entry">
    <p>Do you know what value will be alerted if the following is executed as a JavaScript program?</p>

<pre><code>var foo = 1;
function bar() {
	if (!foo) {
		var foo = 10;
	}
	alert(foo);
}
bar();</code></pre>

<p>If it surprises you that the answer is &#8220;10&#8221;, then this one will probably really throw you for a loop:</p>

<pre><code>var a = 1;
function b() {
	a = 10;
	return;
	function a() {}
}
b();
alert(a);</code></pre>

<p>Here, of course, the browser will alert &#8220;1&#8221;. So what&#8217;s going on here? While it might seem strange, dangerous, and confusing, this is actually a powerful and expressive feature of the language. I don&#8217;t know if there is a standard name for this specific behavior, but I&#8217;ve come to like the term &#8220;hoisting&#8221;. This article will try to shed some light on this mechanism, but first lets take a necessary detour to understand JavaScript&#8217;s scoping.</p>

<h2 id='scoping_in_javascript'>Scoping in JavaScript</h2>

<p>One of the sources of most confusion for JavaScript beginners is scoping. Actually, it&#8217;s not just beginners. I&#8217;ve met a lot of experienced JavaScript programmers who don&#8217;t fully understand scoping. The reason scoping is so confusing in JavaScript is because it looks like a C-family language. Consider the following C program:</p>

<pre><code>#include &lt;stdio.h&gt;
int main() {
	int x = 1;
	printf(&quot;%d, &quot;, x); // 1
	if (1) {
		int x = 2;
		printf(&quot;%d, &quot;, x); // 2
	}
	printf(&quot;%d\n&quot;, x); // 1
}</code></pre>

<p>The output from this program will be <code>1, 2, 1</code>. This is because C, and the rest of the C family, has <strong>block-level scope</strong>. When control enters a block, such as the <code>if</code> statement, new variables can be declared within that scope, without affecting the outer scope. This is not the case in JavaScript. Try the following in Firebug:</p>

<pre><code>var x = 1;
console.log(x); // 1
if (true) {
	var x = 2;
	console.log(x); // 2
}
console.log(x); // 2</code></pre>

<p>In this case, Firebug will show <code>1, 2, 2</code>. This is because JavaScript has <strong>function-level scope</strong>. This is radically different from the C family. Blocks, such as <code>if</code> statements, <strong>do not</strong> create a new scope. Only functions create a new scope.</p>

<p>To a lot of programmers who are used to languages like C, C++, C#, or Java, this is unexpected and unwelcome. Luckily, because of the flexibility of JavaScript functions, there is a workaround. If you must create temporary scopes within a function, do the following:</p>

<pre><code>function foo() {
	var x = 1;
	if (x) {
		(function () {
			var x = 2;
			// some other code
		}());
	}
	// x is still 1.
}</code></pre>

<p>This method is actually quite flexible, and can be used anywhere you need a temporary scope, not just within block statements. However, I strongly recommend that you take the time to really understand and appreciate JavaScript scoping. It&#8217;s quite powerful, and one of my favorite features of the language. If you understand scoping, hoisting will make a lot more sense to you.</p>

<h2 id='declarations_names_and_hoisting'>Declarations, Names, and Hoisting</h2>

<p>In JavaScript, a name enters a scope in one of four basic ways:</p>

<ol>
<li><strong>Language-defined:</strong> All scopes are, by default, given the names <code>this</code> and <code>arguments</code>.</li>

<li><strong>Formal parameters:</strong> Functions can have named formal parameters, which are scoped to the body of that function.</li>

<li><strong>Function declarations:</strong> These are of the form <code>function foo() {}</code>.</li>

<li><strong>Variable declarations:</strong> These take the form <code>var foo;</code>.</li>
</ol>

<p>Function declarations and variable declarations are always moved (&#8220;hoisted&#8221;) invisibly to the top of their containing scope by the JavaScript interpreter. Function parameters and language-defined names are, obviously, already there. This means that code like this:</p>

<pre><code>function foo() {
	bar();
	var x = 1;
}</code></pre>

<p>is actually interpreted like this:</p>

<pre><code>function foo() {
	var x;
	bar();
	x = 1;
}</code></pre>

<p>It turns out that it doesn&#8217;t matter whether the line that contains the declaration would ever be executed. The following two functions are equivalent:</p>

<pre><code>function foo() {
	if (false) {
		var x = 1;
	}
	return;
	var y = 1;
}
function foo() {
	var x, y;
	if (false) {
		x = 1;
	}
	return;
	y = 1;
}</code></pre>

<p>Notice that the assignment portion of the declarations were not hoisted. Only the name is hoisted. This is not the case with function declarations, where the entire function body will be hoisted as well. But remember that there are two normal ways to declare functions. Consider the following JavaScript:</p>

<pre><code>function test() {
	foo(); // TypeError &quot;foo is not a function&quot;
	bar(); // &quot;this will run!&quot;
	var foo = function () { // function expression assigned to local variable &#39;foo&#39;
		alert(&quot;this won&#39;t run!&quot;);
	}
	function bar() { // function declaration, given the name &#39;bar&#39;
		alert(&quot;this will run!&quot;);
	}
}
test();</code></pre>

<p>In this case, only the function declaration has its body hoisted to the top. The name &#8216;foo&#8217; is hoisted, but the body is left behind, to be assigned during execution.</p>

<p>That covers the basics of hoisting, which is not as complex or confusing as it seems. Of course, this being JavaScript, there is a little more complexity in certain special cases.</p>

<h3 id='name_resolution_order'>Name Resolution Order</h3>

<p>The most important special case to keep in mind is name resolution order. Remember that there are four ways for names to enter a given scope. The order I listed them above is the order they are resolved in. In general, if a name has already been defined, it is never overridden by another property of the same name. This means that a function declaration takes priority over a variable declaration. This does not mean that an assignment to that name will not work, just that the declaration portion will be ignored. There are a few exceptions:</p>

<ul>
<li>The built-in name <code>arguments</code> behaves oddly. It seems to be declared following the formal parameters, but before function declarations. This means that a formal parameter with the name <code>arguments</code> will take precedence over the built-in, even if it is undefined. This is a bad feature. Don&#8217;t use the name <code>arguments</code> as a formal parameter.</li>

<li>Trying to use the name <code>this</code> as an identifier anywhere will cause a SyntaxError. This is a good feature.</li>

<li>If multiple formal parameters have the same name, the one occurring latest in the list will take precedence, even if it is undefined.</li>
</ul>

<h3 id='named_function_expressions'>Named Function Expressions</h3>

<p>You can give names to functions defined in function expressions, with syntax like a function declaration. This does not make it a function declaration, and the name is not brought into scope, nor is the body hoisted. Here&#8217;s some code to illustrate what I mean:</p>

<pre><code>foo(); // TypeError &quot;foo is not a function&quot;
bar(); // valid
baz(); // TypeError &quot;baz is not a function&quot;
spam(); // ReferenceError &quot;spam is not defined&quot;

var foo = function () {}; // anonymous function expression (&#39;foo&#39; gets hoisted)
function bar() {}; // function declaration (&#39;bar&#39; and the function body get hoisted)
var baz = function spam() {}; // named function expression (only &#39;baz&#39; gets hoisted)

foo(); // valid
bar(); // valid
baz(); // valid
spam(); // ReferenceError &quot;spam is not defined&quot;</code></pre>

<h2 id='how_to_code_with_this_knowledge'>How to Code With This Knowledge</h2>

<p>Now that you understand scoping and hoisting, what does that mean for coding in JavaScript? The most important thing is to always declare your variables with a <code>var</code> statement. I <strong>strongly</strong> recommend that you have <em>exactly one</em> <code>var</code> statement per scope, and that it be at the top. If you force yourself to do this, you will never have hoisting-related confusion. However, doing this can make it hard to keep track of which variables have actually been declared in the current scope. I recommend using <a href='http://www.jslint.com' target='_blank'>JSLint</a> with the <code>onevar</code> option to enforce this. If you&#8217;ve done all of this, your code should look something like this:</p>

<pre><code>/*jslint onevar: true [...] */
function foo(a, b, c) {
    var x = 1,
    	bar,
    	baz = &quot;something&quot;;
}</code></pre>

<h2 id='what_the_standard_says'>What the Standard Says</h2>

<p>I find that it&#8217;s often useful to just consult the <a href='http://www.mozilla.org/js/language/E262-3.pdf' target='_blank'>ECMAScript Standard (pdf)</a> directly to understand how these things work. Here&#8217;s what it has to say about variable declarations and scope (section 12.2.2):</p>

<blockquote>
<p>If the variable statement occurs inside a FunctionDeclaration, the variables are defined with function-local scope in that function, as described in section 10.1.3. Otherwise, they are defined with global scope (that is, they are created as members of the global object, as described in section 10.1.3) using property attributes { DontDelete }. Variables are created when the execution scope is entered. A Block does not define a new execution scope. Only Program and FunctionDeclaration produce a new scope. Variables are initialised to undefined when created. A variable with an Initialiser is assigned the value of its AssignmentExpression when the VariableStatement is executed, not when the variable is created.</p>
</blockquote>

<p>I hope this article has shed some light on one of the most common sources of confusion to JavaScript programmers. I have tried to be as thorough as possible, to avoid creating more confusion. If I have made any mistakes or have large omissions, please let me know.</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-02-03" pubdate>2010-02-03</time>
  
  <h1><a href="/2010/2/SearchReplace-in-the-DOM-with-jQuery">Search/Replace in the DOM with jQuery</a></h1>
</header>
  <div class="span-17 last entry">
    <p>Ever had a need to to a text search/replace through the DOM?  For articles in drafting on this blog I often use the form (TODO: something) as notes for myself to do some more research.  I don't want them sticking around in the text I publish, so I highlighted them red (only for myself).  Here's the script I used to accomplish that:</p>
<pre class="js inline">jQuery(function () {
	jQuery(":contains(TODO)").not(":has(:contains(TODO))").each(function () {
		var that = $(this),
			html = that.html();

		html = html.replace(/(\(TODO:.*?\))/g, "&lt;span class=\"todo\"&gt;$1&lt;/span&gt;");
		that.html(html);
	});
});</pre>
<p>The trick is to find only the nodes that contain the actual text, not ancestors of such nodes, which is what you would get with just <code class="js inline">jQuery(":contains(TOOD)")</code>.  Filtering with <code class="js inline">.not(":has(:contains(TODO))")</code> ensures you've got the bottom most ones.  I tried doing this with the <code class="js inline">":not()"</code> filter, but it didn't work.  I guess that might be a jQuery bug, but the <code class="js inline">.not()</code> method is a fine alternative.</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-02-01" pubdate>2010-02-01</time>
  
  <h1><a href="/2010/2/Why-JavaScripts-new-Keyword-Sucks">Why JavaScript's "new" Keyword Sucks</a></h1>
</header>
  <div class="span-17 last entry">
    <pre><code>&gt;&gt;&gt; function F() { return function inner() { return &quot;inner invoked&quot;; }; }
&gt;&gt;&gt; F()
inner()
&gt;&gt;&gt; F()()
&quot;inner invoked&quot;
&gt;&gt;&gt; new F
inner()
&gt;&gt;&gt; new F()
inner()
&gt;&gt;&gt; (new F)
inner()
&gt;&gt;&gt; (new F)()
&quot;inner invoked&quot;
&gt;&gt;&gt; new (F())
{ }
&gt;&gt;&gt; new ((F)())
{ }
&gt;&gt;&gt; (new F())()
&quot;inner invoked&quot;</code></pre>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2010-01-29" pubdate>2010-01-29</time>
  
  <h1><a href="/2010/1/Preloading-JS-and-CSS-as-Print-Stylesheets">Preloading JS and CSS as Print Stylesheets</a></h1>
</header>
  <div class="span-17 last entry">
    <p><em><strong>UPDATE: This technique has turned out to be dangerous in Chrome.  It seems that Chrome will load the JS files into the cache, but  then set an implied type="text/css" on them.  This means that it will refuse to re-use them as JavaScript on future pages, until they have left the cache.  I can no longer recommend this technique, but hope that it was at least interesting.  I'll be working on a follow-up post about alternatives.</strong></em></p>
<p>One of Yahoo's <a href="http://developer.yahoo.com/performance/rules.html" target="_blank">Best Practices for Speeding Up Your Web Site</a> is "Preload Components".  Most people are already familiar with doing this for images.  Code for that usually looks like this:</p>
<p><pre class="js">var img = Image();
img.src = "/path/to/something.jpg";</pre></p>
<p>This code works in all browsers, and causes that image to be downloaded and placed in the browser's cache.</p>
<p>But what if we want to go further?  For a lot of today's big applications, images are no longer the only bandwidth hog.  An application I work on has more than 2MB worth of JavaScript, CSS, and data (stored in JavaScript files).  We found that users on slow connections could take up to <em>60 seconds</em> to load our application for the first time!  Obviously, we could benefit from intelligently pre-loading this data in the background, on an earlier page where they don't need it yet.  But how?</p>
<p>My first attempt was just to use the <code class="js inline">Image()</code> method above, but point at our text files instead.  This didn't work in Firefox.  I'm not sure why, but those files never appeared in the cache with that method.  So our next idea was to use <code class="html inline">&lt;iframe&gt;</code> tags.  This worked great, until we tried it in Internet Explorer.  IE chose to warn the user that our page was trying to download data they didn't ask for, and blocked the downloads until they approved them.  Obviously, this wouldn't work either.</p>
<p>This left us scratching our heads, but we eventually had a breakthrough.  There is one other tag that is used to include text files in a web page.  That's the <code class="html inline">&lt;link rel="stylesheet"&gt;</code> tag.  But this couldn't possibly work with JavaScript, could it?  It turns out it could!</p>
<pre class="js">var preload = function (file) {
	var elem,
		tag = "link",
		attr = "href",
		extra = " rel=\"stylesheet\" media=\"print\" ",
		target = "head";

	elem = jQuery(["&lt;", tag, extra, attr, "=\"", file, "\"&lt;&gt;/", tag, "&gt;"].join(''));
	elem.load(function () {
		elem.remove();
	});
	jQuery(target).append(elem);

	return elem;
};</pre>
<p>This function creates a temporary <code class="html inline">&lt;link&gt;</code> tag in the <code class="html inline">&lt;head&gt;</code> of your page, pointing at the requested file.  To work across all browsers, we needed to give it the rel="stylesheet" attribute.  To not cause preloaded CSS files to try and apply themselves to the current page, or trigger a re-flow, we added media="print".  Once the element has loaded, it removes itself from the DOM, but the file remains in the browser's cache.  While this example relies on the jQuery library, there is no reason it could not be easily re-written without such a dependency, or written as a jQuery plugin (providing <code class="js inline">jQuery.preload()</code>).</p>
<p>This technique cut our aforementioned page load from 60s to 20s, over a slow connection.  I think this is a complete solution, and seems to work in all major browsers.  What do you think?</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2009-11-28" pubdate>2009-11-28</time>
  
  <h1><a href="/2009/11/Consuljs-Simple-Logging-Abstraction">Consul.js, Simple Logging Abstraction</a></h1>
</header>
  <div class="span-17 last entry">
    <p>I've been reading <em>Coders At Work</em> by Peter Seibel, and one question he asks in every interview is "How do you debug - print statements, debugger like gdb, or something else?".  For me, print statements are my first tool for any situation.  That's why Firebug is so crucial to my work on the web, because writing and debugging advanced JavaScript would be a nightmare without it.  While working on code, my files are littered with <code class="js inline">console.log()</code> statements and the like.  Unfortunately, shipping code with these statements is a no-no, so I usually pull them out.  Frustrated with this process, I decided to build an alternative and throw some new features in along the way.</p>

<p><pre class="js">consul.log("This is a log message");
consul.warn("I even support fancier %s features like %o.", "Firebug", "format strings");
consul.turnOff();
consul.assert(false, "I'm off, so you won't see this error fire.");
consul.turnOn();
consul.info("See this message in Firebug, Chrome, Safari, Firebug Lite, IE8, and Opera.")</pre></p>

<p>Meet <a href="http://github.com/bcherry/bcherry/blob/master/bcherry-web/static/lib/js/consul.js">consul.js</a>, which acts as a wrapper for the standard <code class="js inline">window.console</code> features from <a href="http://getfirebug.com/wiki/index.php/Console_API">Firebug</a>.  Using it is simple, as you see above.  Just include the file, and start using <code class="js inline">consul</code> instead of <code class="js inline">console</code>.  You can easily turn it off for your live code, but have easy access to the messages by simply turning it back on from the command line.</p>

<p>In addition to what you'd expect, using consul.js ensures that you can view your messages and assertions in any browser.  Currently, it supports the latest versions of Firebug, Chrome, and Safari (you'll need the JS console for the latter two).  I also built in support for most commands in Internet Explorer 8, provided you've got the developer tools open.  Opera Dragonfly support was harder, since it doesn't offer much logging features.  However, most things work through <code class="js inline">window.opera.postError()</code>.  Regardless, for IE and Opera (as well as any other browser), it checks for Firebug Lite and outputs there if it finds it, instead of the built-in dev tools.</p>

<p>For a list of features and browser support, look no further than the code itself:</p>

<p><pre class="js">var consoleFuncs = {
	log         : b("firebug", "firebuglite", "chromium", "safari", "ie", "opera"),
	debug       : b("firebug", "firebuglite", "chromium", "safari"),
	info        : b("firebug", "firebuglite", "chromium", "safari", "ie", "opera"),
	warn        : b("firebug", "firebuglite", "chromium", "safari", "ie", "opera"),
	error       : b("firebug", "firebuglite", "chromium", "safari", "ie", "opera"),
	assert      : b("firebug", "firebuglite", "chromium", "safari", "ie", "opera"),
	dir         : b("firebug", "firebuglite", "chromium", "safari"),
	dirxml      : b("firebug", "firebuglite", "chromium", "safari"),
	trace       : b("firebug", "firebuglite", "chromium", "safari"),
	group       : b("firebug", "firebuglite", "chromium", "safari"),
	groupEnd    : b("firebug", "firebuglite", "chromium", "safari"),
	time        : b("firebug", "firebuglite", "chromium", "safari"),
	timeEnd     : b("firebug", "firebuglite", "chromium", "safari"),
	count       : b("firebug", "firebuglite", "chromium", "safari")
};</pre></p>

<p>If a function is not supported in a particular browser, it will simply be ignored, rather than throwing an error.</p>

<p>So <a href="http://github.com/bcherry/bcherry/blob/master/bcherry-web/static/lib/js/consul.js">give it a shot</a>, and let me know what you think!  This tool helped me build this blog's front-end code, and has already been ported into the code I use at work, so I can take advantage of the same tool.  I think it's a big win for JavaScript developers who rely on the Firebug console, and introduces a lot of new flexibility without degrading simplicity.</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2009-11-05" pubdate>2009-11-05</time>
  
  <h1><a href="/2009/11/JS-Find-and-Replace-with-SplitJoin">JS Find-and-Replace with Split/Join</a></h1>
</header>
  <div class="span-17 last entry">
    <p><strong><em>Update: This advice is now totally out-of-date and wrong. Just use <code>replace</code>. As <a href='http://jsperf.com/test-join-and-split'>recent Browserscope results show</a>, all browsers have optimized <code>replace</code> to be much faster than <code>split</code>/<code>join</code>. Thanks to Luigi van der Pal for pointing this out in the comments!</em></strong></p>

<p>When trying to do a find-and-replace in Javascript with static search and replace strings, it&#8217;s always faster to use <code>String.split()</code> and <code>String.join()</code> than to use <code>String.replace()</code>. Compare:</p>

<pre><code>var myString = &#39;......some long text.....&#39;; 
mystring.replace(/,/g,&quot;; &quot;); // Replace the commas with semi-colon-space</code></pre>

<p>with</p>

<pre><code>mystring.split(&quot;,&quot;).join(&quot;; &quot;); // Replace the commas with semi-colon-space</code></pre>

<p>The latter split/join method will always be faster. Note that this is only useful for static find-and-replace. For instance, you could not do anything like the following with splits and joins:</p>

<pre><code>mystring.replace(/^[0-9]+([A-Za-z]*)/g, &quot;$1&quot;);</code></pre>

<p>Of course, you could also use this method to strip characters out of a string:</p>

<pre><code>mystring.split(&quot;,&quot;).join(&#39;&#39;);</code></pre>

<p>Good luck!</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2009-11-05" pubdate>2009-11-05</time>
  
  <h1><a href="/2009/11/Javascript-Pseudo-threading">Javascript Pseudo-threading</a></h1>
</header>
  <div class="span-17 last entry">
    <p><strong><em>This post has been migrated from my old, defunct blog at bcherry.net. The links may not work, and the formatting may be wonky.</em></strong></p>

<p>I&#8217;ve been playing around with asynchronous Javascript for repeated large-set actions, in the hopes of generating some useful techniques for real applications. I&#8217;ve narrowed down a successful technique that I call &#8220;simplethreading&#8221;. Check out a demo <a href='http://bcherry.net/simplethreading_old'>here</a> or the resulting source code <a href='http://github.com/bcherry/simplethreading'>here</a>. The demo lets you play with the size of the data set, and also the operation queue size. I found that queuing operations in batches was quite a bit faster than queuing them individually, so that each fired event will process a few data objects instead of just 1. I&#8217;d guess the reason for this is that Javascript only supports timeouts at the millisecond level, when most operations are shorter than that. By grouping operations into larger chunks, we can make much better use of the time we&#8217;re given.</p>

<p>Here&#8217;s the code for both the blocking (I call it &#8220;singlethreaded&#8221;) and non-blocking (I call it &#8220;simplethreaded&#8221; because it&#8217;s not really multi-threaded, but it&#8217;s not really single-threaded either) version. Note that <code>{@class=js inline}ST.s</code> and <code>{@class=js inline}ST.n</code> refer to the querystring parameters &#8216;s&#8217; and &#8216;n&#8217;.:</p>

<pre><code>ST.functions = [
	function (n, context) {
		$(context).append($(&quot;&lt;div&gt;&quot;).addClass(&quot;result&quot;).attr(&quot;id&quot;,&quot;r&quot;+n).text(n));
	}, function (n, context) {
		$(&quot;#r&quot; + n + &quot;.result&quot;, context).addClass(&quot;dark&quot;);
	}, function (n, context){
		$(&quot;#r&quot; + n + &quot;.result&quot;, context).remove();
	}
];

/** singlethreaded approach **/
ST.singleStage = 0;
ST.SingleGenerator = function(n) {
	var i = 0;
	this.next = function() {
		if (i &amp;gt; n || i &amp;gt; ST.singlelimit) {
			return null;
		}
		return i++;
	};
};
ST.startsingle = function() {
	var context = $(&quot;#singlethreaded .output&quot;);
	var gen = new ST.SingleGenerator(ST.n);
	var n;
	var workFn = ST.functions[ST.singleStage];
	ST.singleStage++;
	ST.singleStage = ST.singleStage % ST.functions.length;
	while ((n = gen.next()) !== null) {
		workFn(n,context);
	}
};

/** simplethreaded approach **/
ST.simpleStage = 0;
ST.SimpleGenerator = function(n) {
	var i = 0;
	this.next = function() {
		if (i &amp;gt; n) {
			return null;
		}
		return i++;
	};
};
ST.startsimple = function() {
	var context = $(&quot;#simplethreaded .output&quot;);
	var gen = new ST.SimpleGenerator(ST.n);
	var n;
	var workFn = ST.functions[ST.simpleStage];
	ST.simpleStage++;
	ST.simpleStage = ST.simpleStage % ST.functions.length;
	var fn = function() {
		var i = 0;
		while (i++ &amp;lt; ST.s &amp;amp;&amp;amp; (n = gen.next()) !== null) {
			workFn(n,context);
		}
		if (n === null) {
			clearInterval(threadID);
		}
	};
	var threadID = setInterval(fn,1);
};</code></pre>

<p>The resulting code is actually pretty straightforward. The key is to maintain the ID returned by the <code>{@class=js inline}setInterval()</code> call so it can be killed when you&#8217;re done with your work. Normally this would get stuffed into a global, but by wrapping the whole lot into a function and then sending a local function reference into <code>{@class=js inline}setInterval()</code>, I can take advantage of Javascript&#8217;s closure to keep the locals I need around for every asynchronous function call, which is really awesome.</p>

<p>Also, using a generator is a pretty neat way to produce the data I need, and lets me work with arbitrary data pretty easily. In a real application where the data is coming from the server asynchronously, I can have the generator returning data from a queue as it comes in, while returning flags like &#8220;all done&#8221; so the thread knows it won&#8217;t see more data or &#8220;wait for it&#8221; so the thread can stick around and poll for new data when it comes in.</p>

<p>I think that if I were to bring this into a real application, I would have it decide between singlethreaded or simplethreaded dynamically, because it&#8217;s obvious that singlethreaded is much better for smaller sets.</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2009-11-05" pubdate>2009-11-05</time>
  
  <h1><a href="/2009/11/jQuery-Micro-templates">jQuery Micro-templates</a></h1>
</header>
  <div class="span-17 last entry">
    <p>John Resig wrote a neat micro-templating Javascript function a <a href='http://ejohn.org/blog/javascript-micro-templating/'>while back</a>. I&#8217;ve been playing with this, and have discovered two things:</p>

<ol>
<li>
<p>These templates are totally nestable. Just make an element to be templated within a template, and call the sub-template code beneath the main call.</p>
</li>

<li>
<p>I found myself tending to do lines like <code>$(&quot;...&quot;).html(tmpl(&quot;...&quot;,{...}))</code>, which seemed clumsy. It was very easy to extend jQuery to include this templating engine (just add this underneath the existing code):</p>

<p>jQuery.fn.tmpl = function(str,data){ return this.html(tmpl(str,data)); }</p>
</li>
</ol>

<p>Then you can just do the following to templatize any number of elements:</p>

<pre><code>$(&quot;.myElems&quot;).tmpl(&quot;myTemplate&quot;,myDataObj);</code></pre>

<p>I&#8217;m still playing with these templates, and working on a new project, so I hope to have more to write about it soon.</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2009-11-05" pubdate>2009-11-05</time>
  
  <h1><a href="/2009/11/Managing-CSS-Through-Javascript">Managing CSS Through JavaScript</a></h1>
</header>
  <div class="span-17 last entry">
    <p>It&#8217;s often very difficult to keep track of what CSS goes where. Especially when you load up on Javascript controls and files in a large application, which render markup that depends on some CSS being there. One solution is to &#8220;inline&#8221; the CSS in the JavaScript, by adding style to each element as it&#8217;s created. This works, but it&#8217;s messy. Also, browsers are heavily optimized to apply CSS, faster than any Javascript solution could be. But when you&#8217;ve got a fancy script manager like LABjs, remembering to statically link all of the important CSS is a pain. Especially so if you&#8217;re not sure at page load whether certain CSS will be needed. Here&#8217;s a simple function to do this for you (note the XHR stuff is pretty basic, and I&#8217;d recommend changing it to use whatever JS library you use in your applications):</p>

<pre><code>(function() {
  var loadedFiles = {}; 
  this.$css = function(filename) { 
    if (loadedFiles[filename]) { 
      return; 
    } 
    loadedFiles[filename] = true; 
    var xhr = new XMLHttpRequest(); 
    xhr.open(&quot;GET&quot;, filename, true); 
    xhr.onreadystatechange = function() { 
      if (xhr.readyState === 4) { 
        var head = document.getElementsByTagName(&quot;head&quot;)[0]; 
        var styleTag = document.createElement(&quot;style&quot;); 
        var style = document.createTextNode(xhr.responseText);
        styleTag.appendChild(style); 
        head.appendChild(styleTag);
      } 
    }; 
    xhr.send(null); 
  };
})();</code></pre>

<p>Now, from any Javascript, just do the following:</p>

<pre><code>$css(&quot;styles/main.css&quot;); 
$css(&quot;styles/controls.css&quot;);</code></pre>

<p>The <code>$css()</code> function keeps track of what&#8217;s already been loaded, so that you&#8217;ll never load the same stylesheet twice. So don&#8217;t be afraid to spell out each CSS dependency your Javascript files have.</p>
  </div>
</article>

  

  
    <article class="span-17 last">
  <header class="span-17 last">
  
    <time class="alt" datetime="2009-11-05" pubdate>2009-11-05</time>
  
  <h1><a href="/2009/11/Building-a-Better-Friend-Selector">Building a Better Friend Selector</a></h1>
</header>
  <div class="span-17 last entry">
    <p><strong><em>This post has been migrated from my old, defunct blog at bcherry.net. The links may not work, and the formatting may be wonky.</em></strong></p>

<p>Working in social entertainment, one of the lynchpins of the entire business is the friend selector. Without it, there is virtually no way to grow your customer base. Having a simple, effective friend selector is absolutely critical. On Facebook, they provide you with either the <a href='http://wiki.developers.facebook.com/index.php/Fb:multi-friend-selector' target='_blank'>multi-friend-selector</a> or the <a href='http://wiki.developers.facebook.com/index.php/Fb:multi-friend-selector_%28condensed%29' target='_blank'>condensed multi-friend-selector</a>. If you&#8217;ve ever played a Facebook game like <a href='http://apps.new.facebook.com/inthemafia/' target='_blank'>Mafia Wars</a> or <a href='http://apps.facebook.com/onthefarm' target='_blank'>Farmville</a> or <a href='http://apps.facebook.com/slidepets/' target='_blank'>SuperPoke! Pets</a>, then you&#8217;re probably already familiar with both of these controls. However, the situation is much more sparse on other networks. And if you&#8217;re talking about implementing a network independent game, like <a href='http://www.superpokepets.com' target='_blank'>SuperPokePets.com</a>, then you&#8217;ll eventually need to write your own.</p>

<p>I&#8217;ve begun a project in my free time to make a truly great friend selector control, for use in our own applications and elsewhere. You can find the result <a href='http://bcherry.net/babfs' target='_blank'>here</a>, and the source code is available on <a href='http://github.com/bcherry/babfs/tree/master' target='_blank'>GitHub</a>. I&#8217;m constantly working on improving it. What I&#8217;ve built is not useful just for friends lists, but could feasibly serve as a good control for any sort of list selection. It began as a simple exercise in <a href='http://bcherry.net/archives/89' target='_blank'>good Javascript</a>, seeing how quickly I could replicate every feature of the Facebook condensed multi-friend-selector (the answer was about 2 hours). But as I worked on it more, I realized that I was capable of producing something of real value to our business. I hope to tackle advanced problems like performance with our so-called &#8220;whale users&#8221;, who have tens of thousands of friends. My initial attempt starts to break down over 1000 friends, and crashes the browser as I reach above 10000.</p>

<p>You can use it by including the Javascript and CSS files (found in <a href='http://github.com/bcherry/babfs/tree/master' target='_blank'>Git</a>), then making a simple call to the constructor. The data is expected to be a list of objects, each of which has the properties &#8216;name&#8217;, &#8216;id&#8217;, and &#8216;tabs&#8217; (optional). If you don&#8217;t want the tabs, just don&#8217;t pass a &#8216;tabs&#8217; list, and don&#8217;t include it on your dataset. In the future, the object returned from the constructor will have some useful public methods.</p>

<pre><code>var bfs = new BetterFriendSelector({
  action:&quot;index.html&quot;,
  method:&quot;GET&quot;,
  submit_text:&quot;Send Friend Request&quot;,
  data:fs_data,
  limit:10,
  elem:$(&quot;#bfs&quot;),
  tabs:[{key:&quot;hasapp&quot;,name:&quot;Friends With App&quot;},          {key:&quot;nonapp&quot;,name:&quot;Friends Without App&quot;}],
  extra_form_params:extra_form_params
});</code></pre>

<p>Anyways, I&#8217;d like to go through the implementation of what I have so far.</p>
<h3>Disappearing Checkboxes</h3><p>This is the best feature of the condensed selector on Facebook.  When a user clicks to select one of their friends, the entry moves to the "selected" area, but with an 'X' instead of a checkbox.  This makes it easy to see who's been selected, even while filtering or tabbing the results.  Here's how I did that:</p>
<pre><code>// Friend selected event
selector.find(&quot;input[type=checkbox]&quot;).change(function(){
  var count = selector.find(&quot;input[type=checkbox][checked=true]     length;
  if (count &gt; limit) {
    $(this).attr(&quot;checked&quot;,false);
    return false;
  }
  $(this).parents(&quot;.friend&quot;).addClass(&quot;hidden&quot;);
  var selected_elem = $(&quot;&lt;div id=&quot;&quot;&gt;&quot;).addClass(&quot;selected_frien    ;
  selected_elem.tmpl(BFS.templates.selected_elem,{&quot;name&quot;:$(this    siblings(&quot;label&quot;).text(), &quot;id&quot;:$(this).attr(&quot;id&quot;)});
  selector.find(&quot;.selected&quot;).append(selected_elem);
});
// Friend unselected event
selector.find(&quot;.remove&quot;).live(&quot;click&quot;,function(){
  selector.find(&quot;.unselected #&quot; + $(this).attr(&quot;id&quot;)).att    &quot;checked&quot;,false).parents(&quot;.friend&quot;).removeClass(&quot;hidden&quot;);
  $(this).parents(&quot;.selected_friend&quot;).remove();
});</code></pre>
<p>I think this is fairly straightforward, so I'll just list a few points to help understand it:</p><ol>
<li>The correct event to bind is "change".  My first attempt had me binding to the "click" event on the checkbox, which was flawed.  You can modify the checkbox by clicking it, with your keyboard, or clicking on the label, not to mention other Javascript.  "change" catches all of these options</li>
<li>I use the friend's id to index the items.  Checkboxes have an id of 'cbXXX' and the corresponding 'selected' element has an id of 's_cbXXX'.</li>
<li>I'm using John Resig's <a href='http://bcherry.net/archives/97' target='_blank'>micro-templates</a>, so that's what the <code class='js inline'>.tmpl()</code> call is.  The template data is stored in a static collection of strings.</li>
<li>I allow the developer to specify a selection limit ("select up to X friends"), and enforce that in the 'change' event.  Returning false prevents the checkbox from becoming selected.</li>
<li>My first attempt used <code class='js inline'>.hide()</code> and <code class='js inline'>.show()</code>, which seems to be natural.  I changed it to a class with 'display:none;'.  This is because there are a number of reasons a friend element might be hidden, such as being filtered or toggled.  Using classes for these ensures they stay hidden when I want them to be.</li>
</ol><h3>Typeahead Name Filter</h3><p>There are plenty of solutions for typeahead to be found online, but I decided to implement my own.  It turned out to be really easy, so I'll just show the code and a few points.  The key feature of my implementation is that it filters on the start of the first and last name simultaneously, so entering 'be' will keep both 'Ben Franklin' and 'David Beckham'.</p>
<pre><code>var filter = selector.find(&quot;.filter input&quot;);
var reset_filter = function(){
filter.addClass(&quot;empty&quot;).val(filter.siblings(&quot;.__empty_text&quot;).tex    ));
};
// Filter changed event
var do_filter = function() {
var filter_text = filter.val();
if (filter_text == filter.siblings(&quot;.__empty_text&quot;).text()) {
filter_text = &quot;&quot;;
}
selector.find(&quot;.unselected label&quot;).each(function(){
with($(this)) {
if(!text().match(&quot;^&quot; + filter_text) &amp;&amp; !text().match(&quot;[- \t]+&quot;     filter_text)) {
parents(&quot;.friend&quot;).addClass(&quot;filtered&quot;);
} else {
parents(&quot;.friend&quot;).removeClass(&quot;filtered&quot;);
}
}
});
};
filter.keyup(do_filter);
// Filter preloaded text stuff
reset_filter();
filter.focus(function() {
if ($(this).val() == $(this).siblings(&quot;.__empty_text&quot;).text()) {
$(this).removeClass(&quot;empty&quot;).val(&#39;&#39;);
}
});
filter.blur(function() {
if ($(this).val() == &quot;&quot;) {
reset_filter();
}
});
selector.find(&quot;.filter .clear_filter&quot;).click(function(){
reset_filter();
do_filter();
});</code></pre>
<ol>
<li>I'm using a class instead of <code class='js inline'>.hide()</code> and <code class='js inline'>.show()</code> for the same reason as above</li>

<li>The textbox is watermarked using the text in a hidden element next to the textbox</li>
</ol><h3>What's Next?</h3><p>I hope someone finds this control or it's code to be useful.  I'm going to keep working on it, and I hope to create something that becomes useful at Slide.  My next task is to create a mechanism for handling our "whale users", probably some sort of smart pagination.  I'll also be adding some public methods like <code class='js inline'>selectRandom()</code> to make the control easily programmable.  Another hurdle will be allowing friend data to be loaded dynamically, by passing some sort of generator function to my control.  Again, I hope this was useful, and let me know if you're using or modifying this!</p>
  </div>
</article>

  

  


        </div>

        <!-- Sidebar: Search, links, etc. -->
        <div id="sidebar" class="span-6 last">
          <hr class="space" />

          <div id="links">
            <h3>the author</h3>
            <p>
              Ben is a 25 year-old software engineer. He lives and works in San Francisco. Many people think he invented the term "hoisting" in JavaScript, but this is untrue.
            </p>
            <ul>
              <li><a href="http://twitter.com/bcherry">Twitter</a> - @<a class="twitter-anywhere-user" href="http://twitter.com/bcherry">bcherry</a></li>
              <li><a href="http://github.com/bcherry">GitHub</a> - My Code</li>
              <li><a href="http://www.linkedin.com/in/bcherryprogrammer">LinkedIn</a> - Professional Profile</li>
              <li><a href="http://www.facebook.com/bcherry">Facebook</a> - That Other Social Network</li>
              <li><a href="http://www.bcherry.net/talks/">Presentations</a> - Slides From My Talks</li>
            </ul>
            <iframe allowtransparency="true" frameborder="0" scrolling="no"
              src="http://platform.twitter.com/widgets/follow_button.html?screen_name=bcherry&amp;button=grey&amp;text_color=7F7F7F&amp;link_color=666666"
              style="width:300px; height:20px;"></iframe>
          </div>

          <hr />

          <div id="tags">
            <h3>categories</h3>
            <ul>
            
              <li>
                <a href="/tag/javascript">javascript</a>
                (21)
              </li>
            
              <li>
                <a href="/tag/social%20gaming">social gaming</a>
                (1)
              </li>
            
              <li>
                <a href="/tag/css">css</a>
                (1)
              </li>
            
              <li>
                <a href="/tag/jquery">jquery</a>
                (2)
              </li>
            
              <li>
                <a href="/tag/performance">performance</a>
                (5)
              </li>
            
              <li>
                <a href="/tag/tools">tools</a>
                (2)
              </li>
            
              <li>
                <a href="/tag/html5">html5</a>
                (3)
              </li>
            
              <li>
                <a href="/tag/adequatelygood">adequatelygood</a>
                (1)
              </li>
            
              <li>
                <a href="/tag/timers">timers</a>
                (2)
              </li>
            
              <li>
                <a href="/tag/module%20pattern">module pattern</a>
                (3)
              </li>
            
              <li>
                <a href="/tag/talks">talks</a>
                (1)
              </li>
            
              <li>
                <a href="/tag/slide">slide</a>
                (1)
              </li>
            
              <li>
                <a href="/tag/python">python</a>
                (1)
              </li>
            
              <li>
                <a href="/tag/debugging">debugging</a>
                (1)
              </li>
            
              <li>
                <a href="/tag/testing">testing</a>
                (2)
              </li>
            
              <li>
                <a href="/tag/hashbang">hashbang</a>
                (1)
              </li>
            
            </ul>
          </div>

          <hr />

          
        </div>
      </div>
    </div>

    <!-- Exception Hub start -->
    <script src="http://js.exceptionhub.com/javascripts/eh.js"></script>
    <script>
      ExceptionHub.setup("8ff0f84d25456b049a9c1a83f8e62b56", 21, 'production');
    </script>
    <!-- Exception Hub end -->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>
      jQuery.noConflict();
      jQuery("#archiveLink").click(function() {
        jQuery("#archives").slideToggle();
      });
    </script>

    <!-- Google Analytics -->
    <script type="text/javascript">var _gaq =_gaq||[]; _gaq.push(['_setAccount','UA-251077-4']);_gaq.push(['_trackPageview']);(function(){var ga=document.createElement('script');ga.type='text/javascript';ga.async=true;ga.src=('https:'==document.location.protocol?'https://ssl':'http://www')+'.google-analytics.com/ga.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(ga);})();</script>
  </body>
</html>
